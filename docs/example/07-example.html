<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Data Visualization with R - Relationships</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../example/08-example.html" rel="next">
<link href="../example/06-example.html" rel="prev">
<link href="..//files/favicon-512.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<meta property="og:title" content="Data Visualization with R - Relationships">
<meta property="og:description" content="">
<meta property="og:image" content="https://aysps.github.io/Data-Visualization_2024//files/social-image-f23.png">
<meta property="og:site-name" content="Data Visualization with R">
<meta property="og:locale" content="en_US">
<meta property="og:image:height" content="640">
<meta property="og:image:width" content="1280">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Data Visualization with R</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../syllabus.html" rel="" target="">
 <span class="menu-text">Syllabus</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../schedule.html" rel="" target="">
 <span class="menu-text">Schedule</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../content/index.html" rel="" target="">
 <span class="menu-text">Content</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../lesson/index.html" rel="" target="">
 <span class="menu-text">Lessons</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../example/index.html" rel="" target="" aria-current="page">
 <span class="menu-text">Examples</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../assignment/index.html" rel="" target="">
 <span class="menu-text">Assignments</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../resource/index.html" rel="" target="">
 <span class="menu-text">Resources</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../example/04-example.html">Core types of graphics</a></li><li class="breadcrumb-item"><a href="../example/07-example.html">7: Relationships</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Overview</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Code examples</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/01-example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1: Introduction to R and the tidyverse</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/02-example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2: Graphic design</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/03-example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3: Mapping data to graphics</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Core types of graphics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/04-example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4: Amounts and proportions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/05-example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">5: Themes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/06-example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">6: Uncertainty</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/07-example.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">7: Relationships</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/08-example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">8: Comparisons</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/09-example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">9: Annotations</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Special applications</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/10-example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">10: Interactivity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/11-example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">11: Time</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/12-example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">12: Space</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/13-example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">13: Text</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/14-example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">14: Enhancing graphics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../example/15-example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">15: Sharing R output online</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#live-coding-example" id="toc-live-coding-example" class="nav-link active" data-scroll-target="#live-coding-example">Live coding example</a></li>
  <li><a href="#load-and-clean-data" id="toc-load-and-clean-data" class="nav-link" data-scroll-target="#load-and-clean-data">Load and clean data</a></li>
  <li><a href="#legal-dual-y-axes" id="toc-legal-dual-y-axes" class="nav-link" data-scroll-target="#legal-dual-y-axes">Legal dual y-axes</a></li>
  <li><a href="#combining-plots" id="toc-combining-plots" class="nav-link" data-scroll-target="#combining-plots">Combining plots</a></li>
  <li><a href="#scatterplot-matrices" id="toc-scatterplot-matrices" class="nav-link" data-scroll-target="#scatterplot-matrices">Scatterplot matrices</a></li>
  <li><a href="#correlograms" id="toc-correlograms" class="nav-link" data-scroll-target="#correlograms">Correlograms</a></li>
  <li><a href="#simple-regression" id="toc-simple-regression" class="nav-link" data-scroll-target="#simple-regression">Simple regression</a></li>
  <li><a href="#coefficient-plots" id="toc-coefficient-plots" class="nav-link" data-scroll-target="#coefficient-plots">Coefficient plots</a></li>
  <li><a href="#marginal-effects-plots" id="toc-marginal-effects-plots" class="nav-link" data-scroll-target="#marginal-effects-plots">Marginal effects plots</a></li>
  <li><a href="#predicted-values-and-marginal-effects-in-2023" id="toc-predicted-values-and-marginal-effects-in-2023" class="nav-link" data-scroll-target="#predicted-values-and-marginal-effects-in-2023">Predicted values and marginal effects in 2023</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-git"></i></div><div class="action-links"><p><a href="https://aysps.github.io/Data-Visualization_2024/edit/main/example/07-example.qmd" class="toc-action">Edit this page</a></p><p><a href="https://aysps.github.io/Data-Visualization_2024/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header">
<div class="quarto-title-block d-none d-lg-block"><div><h1 class="title">Relationships</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>

<div class="date-block bg-example text-white p-2">
    <p class="date">Example for Monday, March 18, 2024–Friday, March 22, 2024</p>
</div>
</header>

<p>For this example, we’re going to use historical weather data from the now-defunct <a href="https://darksky.net/forecast/33.7546,-84.39/us12/en">Dark Sky</a> about wind speed and temperature trends for downtown Atlanta (<a href="https://www.google.com/maps/place/33°45'16.4%22N+84°23'24.0%22W/@33.754557,-84.3921977,17z/">specifically <code>33.754557, -84.390009</code></a>) in 2019. I downloaded this data using Dark Sky’s (now-retired-because-they-were-bought-by-Apple) API using the <a href="https://github.com/hrbrmstr/darksky">{darksky} package</a>. If you want to follow along with this example, you can download the data below (you’ll likely need to right click and choose “Save Link As…”):</p>
<ul>
<li><a href="../files/data/external_data/atl-weather-2019.csv"><i class="fa-solid fa-file-csv" aria-label="file-csv"></i> <code>atl-weather-2019.csv</code></a></li>
</ul>
<section id="live-coding-example" class="level2">
<h2 class="anchored" data-anchor-id="live-coding-example">Live coding example</h2>
<div class="ratio ratio-16x9">
<iframe src="https://www.youtube.com/embed/zfEAmJzfbkE" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="" frameborder="0">
</iframe>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Slight differences from the video
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is a slightly cleaned up version of the code from the video.</p>
</div>
</div>
</section>
<section id="load-and-clean-data" class="level2">
<h2 class="anchored" data-anchor-id="load-and-clean-data">Load and clean data</h2>
<p>First, we load the libraries we’ll be using:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)  <span class="co"># For ggplot, dplyr, and friends</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)  <span class="co"># For combining ggplot plots</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GGally)     <span class="co"># For scatterplot matrices</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)      <span class="co"># For converting model objects to data frames</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then we load the data with <code>read_csv()</code>. Here I assume that the CSV file lives in a subfolder in my project named <code>data</code>:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>weather_atl <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/atl-weather-2019.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="legal-dual-y-axes" class="level2">
<h2 class="anchored" data-anchor-id="legal-dual-y-axes">Legal dual y-axes</h2>
<p>It is fine (and often helpful!) to use two y-axes if the two different scales measure the same thing, like counts and percentages, Fahrenheit and Celsius, pounds and kilograms, inches and centimeters, etc.</p>
<p>To do this, you need to add an argument (<code>sec.axis</code>) to <code>scale_y_continuous()</code> to tell it to use a second axis. This <code>sec.axis</code> argument takes a <code>sec_axis()</code> function that tells ggplot how to transform the scale. You need to specify a formula or function that defines how the original axis gets transformed. This formula uses a special syntax. It needs to start with a <code>~</code>, which indicates that it’s a function, and it needs to use <code>.</code> to stand in for the original value in the original axis.</p>
<p>Since the equation for converting Fahrenheit to Celsius is this…</p>
<p><span class="math display">\[
\text{C} = (32 - \text{F}) \times -\frac{5}{9}
\]</span></p>
<p>…we can specify this with code like so (where <code>.</code> stands for the Fahrenheit value):</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>~ (32 - .) * -5 / 9</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here’s a plot of daily high temperatures in Atlanta throughout 2019, with a second axis:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(weather_atl, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> temperatureHigh)) <span class="sc">+</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="at">trans =</span> <span class="sc">~</span> (<span class="dv">32</span> <span class="sc">-</span> .) <span class="sc">*</span> <span class="sc">-</span><span class="dv">5</span><span class="sc">/</span><span class="dv">9</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">name =</span> <span class="st">"Celsius"</span>)) <span class="sc">+</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Fahrenheit"</span>) <span class="sc">+</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="07-example_files/figure-html/atl-weather-dual-axes-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>For fun, we could also convert it to Kelvin, which uses this formula:</p>
<p><span class="math display">\[
\text{K} = (\text{F} - 32) \times \frac{5}{9} + 273.15
\]</span></p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(weather_atl, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> temperatureHigh)) <span class="sc">+</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="at">trans =</span> <span class="sc">~</span> (. <span class="sc">-</span> <span class="dv">32</span>) <span class="sc">*</span> <span class="dv">5</span><span class="sc">/</span><span class="dv">9</span> <span class="sc">+</span> <span class="fl">273.15</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">name =</span> <span class="st">"Kelvin"</span>)) <span class="sc">+</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Fahrenheit"</span>) <span class="sc">+</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="07-example_files/figure-html/atl-weather-dual-axes-kelvin-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="combining-plots" class="level2">
<h2 class="anchored" data-anchor-id="combining-plots">Combining plots</h2>
<p>A good alternative to using two y-axes is to use two plots instead. The <a href="https://github.com/thomasp85/patchwork">{patchwork} package</a> makes this <em>really</em> easy to do with R. There are other similar packages that do this, like {cowplot} and {gridExtra}, but I’ve found that {patchwork} is the easiest to use <em>and</em> it actually aligns the different plot elements like axis lines and legends (yay alignment in CRAP!). The <a href="https://patchwork.data-imaginist.com/articles/guides/assembly.html">documentation for {patchwork}</a> is really great and full of examples—you should check it out to see all the things you can do with it!</p>
<p>To use {patchwork}, we need to (1) save our plots as objects and (2) add them together with <code>+</code>.</p>
<p>For instance, is there a relationship between temperature and humidity in Atlanta? We can plot both:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Temperature in Atlanta</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>temp_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(weather_atl, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> temperatureHigh)) <span class="sc">+</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="at">trans =</span> <span class="sc">~</span> (<span class="dv">32</span> <span class="sc">-</span> .) <span class="sc">*</span> <span class="sc">-</span><span class="dv">5</span><span class="sc">/</span><span class="dv">9</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">name =</span> <span class="st">"Celsius"</span>)) <span class="sc">+</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Fahrenheit"</span>) <span class="sc">+</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>temp_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="07-example_files/figure-html/create-temp-humid-plots-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Humidity in Atlanta</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>humidity_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(weather_atl, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> humidity)) <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Humidity"</span>) <span class="sc">+</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>humidity_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="07-example_files/figure-html/create-temp-humid-plots-2.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Right now, these are two separate plots, but we can combine them with <code>+</code> if we load {patchwork}:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>temp_plot <span class="sc">+</span> humidity_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="07-example_files/figure-html/patchwork-first-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>By default, {patchwork} will put these side-by-side, but we can change that with the <code>plot_layout()</code> function:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>temp_plot <span class="sc">+</span> humidity_plot <span class="sc">+</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="07-example_files/figure-html/patchwork-vertical-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>We can also play with other arguments in <code>plot_layout()</code>. If we want to make the temperature plot taller and shrink the humidity section, we can specify the proportions for the plot heights. Here, the temperature plot is 70% of the height and the humidity plot is 30%:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>temp_plot <span class="sc">+</span> humidity_plot <span class="sc">+</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">heights =</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">0.3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="07-example_files/figure-html/patchwork-vertical-resized-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="scatterplot-matrices" class="level2">
<h2 class="anchored" data-anchor-id="scatterplot-matrices">Scatterplot matrices</h2>
<p>We can visualize the correlations between pairs of variables with the <code>ggpairs()</code> function in the {GGally} package. For instance, how correlated are high and low temperatures, humidity, wind speed, and the chance of precipitation? We first make a smaller dataset with just those columns, and then we feed that dataset into <code>ggpairs()</code> to see all the correlation information:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GGally)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>weather_correlations <span class="ot">&lt;-</span> weather_atl <span class="sc">%&gt;%</span> </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(temperatureHigh, temperatureLow, humidity, windSpeed, precipProbability)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggpairs</span>(weather_correlations)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="07-example_files/figure-html/ggpairs-1.png" class="img-fluid figure-img" width="864"></p>
</figure>
</div>
</div>
</div>
<p>It looks like high and low temperatures are extremely highly positively correlated (r = 0.92). Wind spped and temperature are moderately negatively correlated, with low temperatures having a stronger negative correlation (r = -0.45). There’s no correlation whatsoever between low temperatures and the precipitation probability (r = -0.03) or humidity and high temperatures (r = -0.03).</p>
<p>Even though <code>ggpairs()</code> doesn’t use the standard <code>ggplot(...) + geom_whatever()</code> syntax we’re familiar with, it does behind the scenes, so you can add regular ggplot layers to it:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggpairs</span>(weather_correlations) <span class="sc">+</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Correlations!"</span>) <span class="sc">+</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dark</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="correlograms" class="level2">
<h2 class="anchored" data-anchor-id="correlograms">Correlograms</h2>
<p>Scatterplot matrices typically include way too much information to be used in actual publications. I use them when doing my own analysis just to see how different variables are related, but I rarely polish them up for public consumption. In the readings for this week, Claus Wilke showed a type of plot called a <a href="https://clauswilke.com/dataviz/visualizing-associations.html#associations-correlograms"><em>correlogram</em></a> which <em>is</em> more appropriate for publication.</p>
<p>These are essentially heatmaps of the different correlation coefficients. To make these with ggplot, we need to do a little bit of extra data processing, mostly to reshape data into a long, tidy format that we can plot. Here’s how.</p>
<p>First we need to build a correlation matrix of the main variables we care about. Ordinarily the <code>cor()</code> function in R takes two arguments—x and y—and it will return a single correlation value. If you feed a data frame into <code>cor()</code> though, it’ll calculate the correlation between each pair of columns</p>
<div class="cell" data-layout-align="center" width="150">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a correlation matrix</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>things_to_correlate <span class="ot">&lt;-</span> weather_atl <span class="sc">%&gt;%</span> </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(temperatureHigh, temperatureLow, humidity, windSpeed, precipProbability) <span class="sc">%&gt;%</span> </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>()</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>things_to_correlate</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="do">##                   temperatureHigh temperatureLow humidity windSpeed precipProbability</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="do">## temperatureHigh              1.00          0.920   -0.030    -0.377            -0.124</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="do">## temperatureLow               0.92          1.000    0.112    -0.450            -0.026</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="do">## humidity                    -0.03          0.112    1.000     0.011             0.722</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="do">## windSpeed                   -0.38         -0.450    0.011     1.000             0.196</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="do">## precipProbability           -0.12         -0.026    0.722     0.196             1.000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The two halves of this matrix (split along the diagonal line) are identical, so we can remove the lower triangle with this code (which will set all the cells in the lower triangle to <code>NA</code>):</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get rid of the lower triangle</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>things_to_correlate[<span class="fu">lower.tri</span>(things_to_correlate)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>things_to_correlate</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="do">##                   temperatureHigh temperatureLow humidity windSpeed precipProbability</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="do">## temperatureHigh                 1           0.92    -0.03    -0.377            -0.124</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="do">## temperatureLow                 NA           1.00     0.11    -0.450            -0.026</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="do">## humidity                       NA             NA     1.00     0.011             0.722</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="do">## windSpeed                      NA             NA       NA     1.000             0.196</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="do">## precipProbability              NA             NA       NA        NA             1.000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Finally, in order to plot this, the data needs to be in tidy (or long) format. Here we convert the <code>things_to_correlate</code> matrix into a data frame, add a column for the row names, take all the columns and put them into a single column named <code>measure1</code>, and take all the correlation numbers and put them in a column named <code>cor</code> In the end, we make sure the measure variables are ordered by their order of appearance (otherwise they plot alphabetically and don’t make a triangle)</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>things_to_correlate_long <span class="ot">&lt;-</span> things_to_correlate <span class="sc">%&gt;%</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert from a matrix to a data frame</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Matrixes have column names that don't get converted to columns when using</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># as.data.frame(), so this adds those names as a column</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">"measure2"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make this long. Take all the columns except measure2 and put their names in</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># a column named measure1 and their values in a column named cor</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>measure2,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"measure1"</span>,</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"cor"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a new column with the rounded version of the correlation value</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nice_cor =</span> <span class="fu">round</span>(cor, <span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove rows where the two measures are the same (like the correlation</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># between humidity and humidity)</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(measure2 <span class="sc">!=</span> measure1) <span class="sc">%&gt;%</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get rid of the empty triangle</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(cor)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Put these categories in order</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">measure1 =</span> <span class="fu">fct_inorder</span>(measure1),</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">measure2 =</span> <span class="fu">fct_inorder</span>(measure2))</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>things_to_correlate_long</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 10 × 4</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="do">##    measure2        measure1              cor nice_cor</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="do">##    &lt;fct&gt;           &lt;fct&gt;               &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="do">##  1 temperatureHigh temperatureLow     0.920      0.92</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="do">##  2 temperatureHigh humidity          -0.0301    -0.03</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="do">##  3 temperatureHigh windSpeed         -0.377     -0.38</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="do">##  4 temperatureHigh precipProbability -0.124     -0.12</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="do">##  5 temperatureLow  humidity           0.112      0.11</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a><span class="do">##  6 temperatureLow  windSpeed         -0.450     -0.45</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a><span class="do">##  7 temperatureLow  precipProbability -0.0255    -0.03</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a><span class="do">##  8 humidity        windSpeed          0.0108     0.01</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a><span class="do">##  9 humidity        precipProbability  0.722      0.72</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a><span class="do">## 10 windSpeed       precipProbability  0.196      0.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Phew. With the data all tidied like that, we can make a correlogram with a heatmap. This is just like <a href="https://datavizm20.classes.andrewheiss.com/example/04-example/#heatmap">the heatmap you made in session 4</a>, but here we manipulate the fill scale a little so that it’s diverging with three colors: a high value, a midpoint value, and a low value.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(things_to_correlate_long, </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> measure2, <span class="at">y =</span> measure1, <span class="at">fill =</span> cor)) <span class="sc">+</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> nice_cor)) <span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="at">low =</span> <span class="st">"#E16462"</span>, <span class="at">mid =</span> <span class="st">"white"</span>, <span class="at">high =</span> <span class="st">"#0D0887"</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="07-example_files/figure-html/cor-heatmap-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>Instead of using a heatmap, we can also use points, which encode the correlation information both as color <em>and</em> as size. To do that, we just need to switch <code>geom_tile()</code> to <code>geom_point()</code> and set the <code>size = cor</code> mapping:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(things_to_correlate_long, </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> measure2, <span class="at">y =</span> measure1, <span class="at">color =</span> cor)) <span class="sc">+</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Size by the absolute value so that -0.7 and 0.7 are the same size</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> <span class="fu">abs</span>(cor))) <span class="sc">+</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient2</span>(<span class="at">low =</span> <span class="st">"#E16462"</span>, <span class="at">mid =</span> <span class="st">"white"</span>, <span class="at">high =</span> <span class="st">"#0D0887"</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_area</span>(<span class="at">max_size =</span> <span class="dv">15</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="07-example_files/figure-html/cor-points-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="simple-regression" class="level2">
<h2 class="anchored" data-anchor-id="simple-regression">Simple regression</h2>
<p>We can also visualize the relationships between variables using regression. Simple regression is easy to visualize, since you’re only working with an X and a Y. For instance, what’s the relationship between humidity and high temperatures during the summer?</p>
<p>First, let’s filter the data to only look at the summer. We also add a column to scale up the humidity value—right now it’s on a scale of 0-1 (for percentages), but when interpreting regression we talk about increases in whole units, so we’d talk about moving from 0% humidity to 100% humidity, which isn’t helpful, so instead we multiply everything by 100 so we can talk about moving from 50% humidity to 51% humidity. We also scale up a couple other variables that we’ll use in the larger model later.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>weather_atl_summer <span class="ot">&lt;-</span> weather_atl <span class="sc">%&gt;%</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(time <span class="sc">&gt;=</span> <span class="st">"2019-05-01"</span>, time <span class="sc">&lt;=</span> <span class="st">"2019-09-30"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">humidity_scaled =</span> humidity <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">moonPhase_scaled =</span> moonPhase <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">precipProbability_scaled =</span> precipProbability <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">cloudCover_scaled =</span> cloudCover <span class="sc">*</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then we can build a simple regression model:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>model_simple <span class="ot">&lt;-</span> <span class="fu">lm</span>(temperatureHigh <span class="sc">~</span> humidity_scaled, </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> weather_atl_summer)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_simple, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 2 × 7</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="do">##   term            estimate std.error statistic  p.value conf.low conf.high</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 (Intercept)      104.       2.35       44.3  1.88e-88   99.5     109.   </span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 humidity_scaled   -0.241    0.0358     -6.74 3.21e-10   -0.312    -0.170</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can interpret these coefficients like so:</p>
<ul>
<li>The intercept shows that the average temperature when there’s 0% humidity is 104°. There are no days with 0% humidity though, so we can ignore the intercept—it’s really just here so that we can draw the line.</li>
<li>The coefficient for <code>humidity_scaled</code> shows that a one percent increase in humidity is associated with a 0.241° decrease in temperature, on average.</li>
</ul>
<p>Visualizing this model is simple, since there are only two variables:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(weather_atl_summer,</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> humidity_scaled, <span class="at">y =</span> temperatureHigh)) <span class="sc">+</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="do">## `geom_smooth()` using formula = 'y ~ x'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="07-example_files/figure-html/plot-simple-model-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>And indeed, as humidity increases, temperatures decrease.</p>
</section>
<section id="coefficient-plots" class="level2">
<h2 class="anchored" data-anchor-id="coefficient-plots">Coefficient plots</h2>
<p>But if we use multiple variables in the model, it gets really hard to visualize the results since we’re working with multiple dimensions. Instead, we can use coefficient plots to see the individual coefficients in the model.</p>
<p>First, let’s build a more complex model:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>model_complex <span class="ot">&lt;-</span> <span class="fu">lm</span>(temperatureHigh <span class="sc">~</span> humidity_scaled <span class="sc">+</span> moonPhase_scaled <span class="sc">+</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>                      precipProbability_scaled <span class="sc">+</span> windSpeed <span class="sc">+</span> pressure <span class="sc">+</span> cloudCover_scaled,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> weather_atl_summer)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_complex, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 7 × 7</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="do">##   term                     estimate std.error statistic   p.value conf.low conf.high</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;                       &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 (Intercept)              262.      125.         2.09  0.0380    14.8      510.    </span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 humidity_scaled           -0.111     0.0757    -1.47  0.143     -0.261      0.0381</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 moonPhase_scaled           0.0116    0.0126     0.917 0.360     -0.0134     0.0366</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 precipProbability_scaled   0.0356    0.0203     1.75  0.0820    -0.00458    0.0758</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="do">## 5 windSpeed                 -1.78      0.414     -4.29  0.0000326 -2.59      -0.958 </span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 6 pressure                  -0.157     0.122     -1.28  0.203     -0.398      0.0854</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="do">## 7 cloudCover_scaled         -0.0952    0.0304    -3.14  0.00207   -0.155     -0.0352</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can interpret these coefficients like so:</p>
<ul>
<li>Holding everything else constant, a 1% increase in humidity is associated with a 0.11° decrease in the high temperature, on average, but the effect is not statistically significant</li>
<li>Holding everything else constant, a 1% increase in moon visibility is associated with a 0.01° increase in the high temperature, on average, and the effect is not statistically significant</li>
<li>Holding everything else constant, a 1% increase in the probability of precipitation is associated with a 0.04° increase in the high temperature, on average, and the effect is not statistically significant</li>
<li>Holding everything else constant, a 1 mph increase in the wind speed is associated with a 1.8° decrease in the high temperature, on average, and the effect <em>is</em> statistically significant</li>
<li>Holding everything else constant, a 1 unit increase in barometric pressure is associated with a 0.15° decrease in the high temperature, on average, and the effect is not statistically significant</li>
<li>Holding everything else constant, a 1% increase in cloud cover is associated with a 0.01° decrease in the high temperature, on average, and the effect <em>is</em> statistically significant</li>
<li>The intercept is pretty useless. It shows that the predicted temperature will be 262° when humidity is 0%, the moon is invisible, there’s no chance of precipitation, no wind, no barometric pressure, and no cloud cover. Yikes.</li>
</ul>
<p>To plot all these things at once, we’ll store the results of <code>tidy(model_complex)</code> as a data frame, remove the useless intercept, and plot it using <code>geom_pointrange()</code>:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>model_tidied <span class="ot">&lt;-</span> <span class="fu">tidy</span>(model_complex, <span class="at">conf.int =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">!=</span> <span class="st">"(Intercept)"</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(model_tidied,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> term)) <span class="sc">+</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>) <span class="sc">+</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high)) <span class="sc">+</span> </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Coefficient estimate"</span>, <span class="at">y =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="07-example_files/figure-html/coef-plot-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Neat! Now we can see how big these different coefficients are and how close they are to zero. Wind speed has a big significant effect on temperature. The others are all very close to zero.</p>
</section>
<section id="marginal-effects-plots" class="level2">
<h2 class="anchored" data-anchor-id="marginal-effects-plots">Marginal effects plots</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
2023 update!
</div>
</div>
<div class="callout-body-container callout-body">
<p>Since recording the video for this section, lots of things have changed in the R world to make finding predicted values and marginal effects <em>a lot</em> easier. (This is why I had you <a href="https://www.andrewheiss.com/blog/2022/05/20/marginalia/">read my guide to marginal things</a> as part of the readings for this session.) <a href="https://vincentarelbundock.github.io/marginaleffects/">The {marginaleffects} R package</a> makes it really nice and easy to get predicted values of an outcome while holding everything else constant—you don’t need to plug values in manually anymore like this section shows.</p>
<p>There’s an example of using {marginaleffects} <a href="#predicted-values-and-marginal-effects-in-2023">down below</a>.</p>
</div>
</div>
<p>Instead of just looking at the coefficients, we can also see the effect of moving different variables up and down like sliders and switches. Remember that regression coefficients allow us to build actual mathematical formulas that predict the value of Y. The coefficients from <code>model_compex</code> yield the following big hairy ugly equation:</p>
<p><span class="math display">\[
\begin{aligned}
\hat{\text{High temperature}} =&amp; 262 - 0.11 \times \text{humidity\_scaled } \\
&amp; + 0.01 \times \text{moonPhase\_scaled } + 0.04 \times \text{precipProbability\_scaled } \\
&amp; - 1.78 \times \text{windSpeed} - 0.16 \times \text{pressure} - 0.095 \times \text{cloudCover\_scaled}
\end{aligned}
\]</span></p>
<p>If we plug in values for each of the explanatory variables, we can get the predicted value of high temperature, or <span class="math inline">\(\hat{y}\)</span>.</p>
<p>The <code>augment()</code> function in the {broom} library allows us to take a data frame of explanatory variable values, plug them into the model equation, and get predictions out. For example, let’s set each of the variables to some arbitrary values (50% for humidity, moon phase, chance of rain, and cloud cover; 1000 for pressure, and 1 MPH for wind speed).</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>newdata_example <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">humidity_scaled =</span> <span class="dv">50</span>, <span class="at">moonPhase_scaled =</span> <span class="dv">50</span>, </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">precipProbability_scaled =</span> <span class="dv">50</span>, <span class="at">windSpeed =</span> <span class="dv">1</span>, </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">pressure =</span> <span class="dv">1000</span>, <span class="at">cloudCover_scaled =</span> <span class="dv">50</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>newdata_example</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 1 × 6</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="do">##   humidity_scaled moonPhase_scaled precipProbability_scaled windSpeed pressure cloudCover_scaled</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="do">##             &lt;dbl&gt;            &lt;dbl&gt;                    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;             &lt;dbl&gt;</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 1              50               50                       50         1     1000                50</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can plug these values into the model with <code>augment()</code>. The <code>se_fit</code> argument gives us standard errors for each prediction:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># I use select() here because augment() returns columns for all the explanatory</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># variables, and the .fitted column with the predicted value is on the far right</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># and gets cut off</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">augment</span>(model_complex, <span class="at">newdata =</span> newdata_example, <span class="at">se_fit =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.fitted, .se.fit)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 1 × 2</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="do">##   .fitted .se.fit</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="do">##     &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 1    96.2    3.19</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Given these weather conditions, the predicted high temperature is 96.2°. Now you’re an armchair meteorologist!</p>
<p>We can follow the same pattern to show how the predicted temperature changes as specific variables change across a whole range. Here, we create a data frame of possible wind speeds and keep all the other explanatory variables at their means:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>newdata <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">windSpeed =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">8</span>, <span class="fl">0.5</span>),</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">pressure =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>pressure),</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">precipProbability_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>precipProbability_scaled),</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">moonPhase_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>moonPhase_scaled),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">humidity_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>humidity_scaled),</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">cloudCover_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>cloudCover_scaled))</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>newdata</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 17 × 6</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="do">##    windSpeed pressure precipProbability_scaled moonPhase_scaled humidity_scaled cloudCover_scaled</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="do">##        &lt;dbl&gt;    &lt;dbl&gt;                    &lt;dbl&gt;            &lt;dbl&gt;           &lt;dbl&gt;             &lt;dbl&gt;</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="do">##  1       0      1016.                     40.2             50.7            64.8              29.5</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="do">##  2       0.5    1016.                     40.2             50.7            64.8              29.5</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="do">##  3       1      1016.                     40.2             50.7            64.8              29.5</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="do">##  4       1.5    1016.                     40.2             50.7            64.8              29.5</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="do">##  5       2      1016.                     40.2             50.7            64.8              29.5</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="do">##  6       2.5    1016.                     40.2             50.7            64.8              29.5</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="do">##  7       3      1016.                     40.2             50.7            64.8              29.5</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="do">##  8       3.5    1016.                     40.2             50.7            64.8              29.5</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="do">##  9       4      1016.                     40.2             50.7            64.8              29.5</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="do">## 10       4.5    1016.                     40.2             50.7            64.8              29.5</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="do">## 11       5      1016.                     40.2             50.7            64.8              29.5</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="do">## 12       5.5    1016.                     40.2             50.7            64.8              29.5</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="do">## 13       6      1016.                     40.2             50.7            64.8              29.5</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="do">## 14       6.5    1016.                     40.2             50.7            64.8              29.5</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="do">## 15       7      1016.                     40.2             50.7            64.8              29.5</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="do">## 16       7.5    1016.                     40.2             50.7            64.8              29.5</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="do">## 17       8      1016.                     40.2             50.7            64.8              29.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>If we feed this big data frame into <code>augment()</code>, we can get the predicted high temperature for each row. We can also use the <code>.se.fit</code> column to calculate the 95% confidence interval for each predicted value. We take the standard error, multiply it by -1.96 and 1.96 (or the quantile of the normal distribution at 2.5% and 97.5%), and add that value to the estimate.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>predicted_values <span class="ot">&lt;-</span> <span class="fu">augment</span>(model_complex, </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">newdata =</span> newdata,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">se_fit =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">conf.low =</span> .fitted <span class="sc">+</span> (<span class="sc">-</span><span class="fl">1.96</span> <span class="sc">*</span> .se.fit),</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">conf.high =</span> .fitted <span class="sc">+</span> (<span class="fl">1.96</span> <span class="sc">*</span> .se.fit))</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>predicted_values <span class="sc">%&gt;%</span> </span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(windSpeed, .fitted, .se.fit, conf.low, conf.high) <span class="sc">%&gt;%</span> </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 6 × 5</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="do">##   windSpeed .fitted .se.fit conf.low conf.high</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="do">##       &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 1       0      95.3   1.63      92.2      98.5</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="do">## 2       0.5    94.5   1.42      91.7      97.2</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="do">## 3       1      93.6   1.22      91.2      96.0</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="do">## 4       1.5    92.7   1.03      90.7      94.7</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="do">## 5       2      91.8   0.836     90.1      93.4</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="do">## 6       2.5    90.9   0.653     89.6      92.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Cool! Just looking at the data in the table, we can see that predicted temperature drops as windspeed increases. We can plot this to visualize the effect:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predicted_values, <span class="fu">aes</span>(<span class="at">x =</span> windSpeed, <span class="at">y =</span> .fitted)) <span class="sc">+</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high),</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"#BF3984"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"#BF3984"</span>) <span class="sc">+</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Wind speed (MPH)"</span>, <span class="at">y =</span> <span class="st">"Predicted high temperature (F)"</span>) <span class="sc">+</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="07-example_files/figure-html/mfx-plot-simple-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>We just manipulated one of the model coefficients and held everything else at its mean. We can manipulate multiple variables too and encode them all on the graph. For instance, what is the effect of windspeed <em>and</em> cloud cover on the temperature?</p>
<p>We’ll follow the same process, but vary both <code>windSpeed</code> and <code>cloudCover_scaled</code>. Instead of using <code>tibble()</code>, we use <code>exapnd_grid()</code>, which creates every combination of the variables we specify. Instead of varying cloud cover by every possible value (like from 0 to 100), we’ll choose four possible cloud cover types: 0%, 33%, 66%, and 100%. Everything else will be at its mean.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>newdata_fancy <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">windSpeed =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">8</span>, <span class="fl">0.5</span>),</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">pressure =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>pressure),</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">precipProbability_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>precipProbability_scaled),</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">moonPhase_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>moonPhase_scaled),</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>                             <span class="at">humidity_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>humidity_scaled),</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>                             <span class="at">cloudCover_scaled =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">33</span>, <span class="dv">66</span>, <span class="dv">100</span>))</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>newdata_fancy</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 68 × 6</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="do">##    windSpeed pressure precipProbability_scaled moonPhase_scaled humidity_scaled cloudCover_scaled</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="do">##        &lt;dbl&gt;    &lt;dbl&gt;                    &lt;dbl&gt;            &lt;dbl&gt;           &lt;dbl&gt;             &lt;dbl&gt;</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="do">##  1       0      1016.                     40.2             50.7            64.8                 0</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="do">##  2       0      1016.                     40.2             50.7            64.8                33</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="do">##  3       0      1016.                     40.2             50.7            64.8                66</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="do">##  4       0      1016.                     40.2             50.7            64.8               100</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="do">##  5       0.5    1016.                     40.2             50.7            64.8                 0</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="do">##  6       0.5    1016.                     40.2             50.7            64.8                33</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="do">##  7       0.5    1016.                     40.2             50.7            64.8                66</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="do">##  8       0.5    1016.                     40.2             50.7            64.8               100</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="do">##  9       1      1016.                     40.2             50.7            64.8                 0</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="do">## 10       1      1016.                     40.2             50.7            64.8                33</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="do">## # ℹ 58 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Notice now that <code>windSpeed</code> repeats four times (0, 0, 0, 0, 0.5, 0.5, etc.), since there are four possible <code>cloudCover_scaled</code> values (0, 33, 66, 100).</p>
<p>We can plot this now, just like before, with wind speed on the x-axis, the predicted temperature on the y-axis, and colored and faceted by cloud cover:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>predicted_values_fancy <span class="ot">&lt;-</span> <span class="fu">augment</span>(model_complex, </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">newdata =</span> newdata_fancy, </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">se_fit =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">conf.low =</span> .fitted <span class="sc">+</span> (<span class="sc">-</span><span class="fl">1.96</span> <span class="sc">*</span> .se.fit),</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">conf.high =</span> .fitted <span class="sc">+</span> (<span class="fl">1.96</span> <span class="sc">*</span> .se.fit)) <span class="sc">%&gt;%</span> </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make cloud cover a categorical variable so we can facet with it</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cloudCover_scaled =</span> <span class="fu">factor</span>(cloudCover_scaled))</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predicted_values_fancy, <span class="fu">aes</span>(<span class="at">x =</span> windSpeed, <span class="at">y =</span> .fitted)) <span class="sc">+</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high, <span class="at">fill =</span> cloudCover_scaled),</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> cloudCover_scaled), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Wind speed (MPH)"</span>, <span class="at">y =</span> <span class="st">"Predicted high temperature (F)"</span>) <span class="sc">+</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="st">"none"</span>, <span class="at">color =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(cloudCover_scaled), <span class="at">nrow =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="07-example_files/figure-html/mfx-complex-1.png" class="img-fluid figure-img" width="864"></p>
</figure>
</div>
</div>
</div>
<p>That’s so neat! Temperatures go down slightly as cloud cover increases. If we wanted to improve the model, we’d add an interaction term between cloud cover and windspeed so that each line would have a different slope in addition to a different intercept, but that’s beyond the scope of this class.</p>
</section>
<section id="predicted-values-and-marginal-effects-in-2023" class="level2">
<h2 class="anchored" data-anchor-id="predicted-values-and-marginal-effects-in-2023">Predicted values and marginal effects in 2023</h2>
<p>Instead of using <code>expand_grid()</code> and <code>augment()</code> to create and plug in a mini dataset of variables to move up and down, we can use <a href="https://vincentarelbundock.github.io/marginaleffects/">the {marginaleffects} package</a> to simplify life!</p>
<p>Remember above where we wanted to see the effect of wind speed on temperature while holding all other variables in the model constant. We had to create a small data frame (<code>newdata</code>) with columns for each of the variables in the model, with everything except <code>windSpeed</code> set to their averages. We then plugged <code>newdata</code> into the model with <code>augment()</code> and calculated the confidence interval around each predicted value using <code>mutate()</code>. It’s a fairly involved process, but it works:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make model</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>model_complex <span class="ot">&lt;-</span> <span class="fu">lm</span>(temperatureHigh <span class="sc">~</span> humidity_scaled <span class="sc">+</span> moonPhase_scaled <span class="sc">+</span> </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>                      precipProbability_scaled <span class="sc">+</span> windSpeed <span class="sc">+</span> pressure <span class="sc">+</span> cloudCover_scaled,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> weather_atl_summer)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Make mini dataset</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>newdata <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">windSpeed =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">8</span>, <span class="fl">0.5</span>),</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">pressure =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>pressure),</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">precipProbability_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>precipProbability_scaled),</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">moonPhase_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>moonPhase_scaled),</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">humidity_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>humidity_scaled),</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">cloudCover_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>cloudCover_scaled))</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plug mini dataset into model</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>predicted_values <span class="ot">&lt;-</span> <span class="fu">augment</span>(model_complex, </span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>                            <span class="at">newdata =</span> newdata,</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>                            <span class="at">se_fit =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">conf.low =</span> .fitted <span class="sc">+</span> (<span class="sc">-</span><span class="fl">1.96</span> <span class="sc">*</span> .se.fit),</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">conf.high =</span> .fitted <span class="sc">+</span> (<span class="fl">1.96</span> <span class="sc">*</span> .se.fit))</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at predicted values</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>predicted_values <span class="sc">%&gt;%</span> </span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(windSpeed, .fitted, .se.fit, conf.low, conf.high) <span class="sc">%&gt;%</span> </span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 6 × 5</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a><span class="do">##   windSpeed .fitted .se.fit conf.low conf.high</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a><span class="do">##       &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a><span class="do">## 1       0      95.3   1.63      92.2      98.5</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a><span class="do">## 2       0.5    94.5   1.42      91.7      97.2</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a><span class="do">## 3       1      93.6   1.22      91.2      96.0</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a><span class="do">## 4       1.5    92.7   1.03      90.7      94.7</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a><span class="do">## 5       2      91.8   0.836     90.1      93.4</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a><span class="do">## 6       2.5    90.9   0.653     89.6      92.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The {marginaleffects} package makes this far easier. We can use the <code>predictions()</code> function to generate, um, predictions. We still need to feed it a smaller dataset of variables to manipulate, but if we use the <code>datagrid()</code> function, we <em>only have to specify the variables we want to move</em>. It will automatically use the averages or typical values for all other variables in the model. It will also automatically create confidence intervals for each prediction—no need for the <code>mutate(conf.low = .fitted + (-1.96 * .se.fit))</code> math that we did previously.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(marginaleffects)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Warning: package 'marginaleffects' was built under R version 4.2.3</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate predictions across a range of windSpeed</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>predicted_values_easy <span class="ot">&lt;-</span> <span class="fu">predictions</span>(</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  model_complex,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">datagrid</span>(<span class="at">windSpeed =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">8</span>, <span class="fl">0.5</span>))</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at predicted values</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>predicted_values_easy <span class="sc">%&gt;%</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(windSpeed, estimate, std.error, conf.low, conf.high)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="do">##  Estimate Std. Error CI low CI high</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="do">##      95.3      1.626   92.2    98.5</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="do">##      94.5      1.425   91.7    97.2</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="do">##      93.6      1.225   91.2    96.0</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="do">##      92.7      1.028   90.7    94.7</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="do">##      91.8      0.836   90.1    93.4</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="do">##      90.9      0.653   89.6    92.2</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="do">##      90.0      0.490   89.0    91.0</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="do">##      89.1      0.374   88.4    89.9</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="do">##      88.2      0.354   87.5    88.9</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="do">##      87.3      0.443   86.5    88.2</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a><span class="do">##      86.5      0.594   85.3    87.6</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a><span class="do">##      85.6      0.772   84.1    87.1</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a><span class="do">##      84.7      0.961   82.8    86.6</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a><span class="do">##      83.8      1.157   81.5    86.1</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a><span class="do">##      82.9      1.356   80.2    85.6</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a><span class="do">##      82.0      1.557   79.0    85.1</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a><span class="do">##      81.1      1.759   77.7    84.6</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a><span class="do">## Columns: windSpeed, estimate, std.error, conf.low, conf.high</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can then plot this really easily too:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predicted_values_easy, <span class="fu">aes</span>(<span class="at">x =</span> windSpeed, <span class="at">y =</span> estimate)) <span class="sc">+</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high),</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"#BF3984"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"#BF3984"</span>) <span class="sc">+</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Wind speed (MPH)"</span>, <span class="at">y =</span> <span class="st">"Predicted high temperature (F)"</span>) <span class="sc">+</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="07-example_files/figure-html/mfx-plot-easy-pred-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>This works when moving multiple variables at the same time, too. Earlier we used <code>expand_grid()</code> to create a mini dataset of different values for both <code>windSpeed</code> and <code>cloudCover</code>, while holding all the other variables at their means. Here’s how to do that with the much easier <code>predictions()</code> function:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>predicted_values_fancy_easy <span class="ot">&lt;-</span> <span class="fu">predictions</span>(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  model_complex,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">datagrid</span>(<span class="at">windSpeed =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">8</span>, <span class="fl">0.5</span>),</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">cloudCover_scaled =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">33</span>, <span class="dv">66</span>, <span class="dv">100</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make cloud cover a categorical variable so we can facet with it</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cloudCover_scaled =</span> <span class="fu">factor</span>(cloudCover_scaled))</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predicted_values_fancy_easy, <span class="fu">aes</span>(<span class="at">x =</span> windSpeed, <span class="at">y =</span> estimate)) <span class="sc">+</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high, <span class="at">fill =</span> cloudCover_scaled),</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> cloudCover_scaled), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Wind speed (MPH)"</span>, <span class="at">y =</span> <span class="st">"Predicted high temperature (F)"</span>) <span class="sc">+</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="st">"none"</span>, <span class="at">color =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(cloudCover_scaled), <span class="at">nrow =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="07-example_files/figure-html/mfx-plot-complex-pred-1.png" class="img-fluid figure-img" width="864"></p>
</figure>
</div>
</div>
</div>
<p>That’s it! <code>predictions()</code> makes this so easy!</p>
<p>If we’re interested in the slopes (or marginal effects) of these lines, we can calculate these really easily too with the <code>slopes()</code> function. For instance, here are the predicted temperatures when just manipulating wind speed:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predicted_values_easy, <span class="fu">aes</span>(<span class="at">x =</span> windSpeed, <span class="at">y =</span> estimate)) <span class="sc">+</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high),</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"#BF3984"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"#BF3984"</span>) <span class="sc">+</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Wind speed (MPH)"</span>, <span class="at">y =</span> <span class="st">"Predicted high temperature (F)"</span>) <span class="sc">+</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="07-example_files/figure-html/mfx-plot-easy-pred-again-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>If we want to see what the slope of that line is when wind speed is 2, 4 and 6, we can use <code>slopes()</code>:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">slopes</span>(model_complex, </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">datagrid</span>(<span class="at">windSpeed =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>)), </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"windSpeed"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This creates a ton of extra columns so we'll just look at a few</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(term, windSpeed, estimate, std.error, p.value, conf.low, conf.high, predicted)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="do">##       Term Estimate Std. Error Pr(&gt;|z|) CI low CI high</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="do">##  windSpeed    -1.78      0.414   &lt;0.001  -2.59  -0.964</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="do">##  windSpeed    -1.78      0.415   &lt;0.001  -2.59  -0.962</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="do">##  windSpeed    -1.78      0.414   &lt;0.001  -2.59  -0.966</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="do">## Columns: term, windSpeed, estimate, std.error, p.value, conf.low, conf.high, predicted</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The <code>estimate</code> column here shows that slope at each of those values of <code>windSpeed</code> is -1.8, meaning a 1-MPH increase in wind speed is associated with a nearly 2° decrease in predicted high temperature, on average. That’s not super exciting though, since the predicted values create a nice straight line, with the same slope across the whole range of the line. It’s also the same number we get from the model coefficient—run <code>tidy(model_complex)</code> and you’ll see that the coefficient for <code>windSpeed</code> is -1.78. Since everything is linear here, using <code>slopes()</code> isn’t that important.</p>
<p>For bonus fun and excitement, let’s make an even more complex model with some non-linear curvy stuff and some interaction terms. We’ll include both wind speed and wind speed squared (since maybe higher wind speeds have a larger effect on predicted temperatures), and the interaction between wind speed and cloud cover (since maybe temperature behaves differently at different combinations of wind speed and cloud cover). Again, I’m not a meteorologist so this model is <em>definitely wrong</em>, but it gives us some neat moving parts we can play with.</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make model</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co"># We square windSpeed with I(windSpeed^2). The I() function lets you do math</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co"># with regression terms.</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co"># We make an interaction term with *</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>model_wild <span class="ot">&lt;-</span> <span class="fu">lm</span>(temperatureHigh <span class="sc">~</span> humidity_scaled <span class="sc">+</span> moonPhase_scaled <span class="sc">+</span> </span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>                   precipProbability_scaled <span class="sc">+</span> windSpeed <span class="sc">+</span> <span class="fu">I</span>(windSpeed<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>                   pressure <span class="sc">+</span> cloudCover_scaled <span class="sc">+</span> (windSpeed <span class="sc">*</span> cloudCover_scaled),</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> weather_atl_summer)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_wild)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 9 × 5</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="do">##   term                         estimate std.error statistic p.value</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;                           &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 (Intercept)                 264.       126.        2.10    0.0374</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 humidity_scaled              -0.122      0.0767   -1.58    0.115 </span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 moonPhase_scaled              0.0109     0.0128    0.849   0.397 </span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 precipProbability_scaled      0.0390     0.0207    1.88    0.0620</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="do">## 5 windSpeed                     0.113      2.58      0.0438  0.965 </span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a><span class="do">## 6 I(windSpeed^2)               -0.198      0.330    -0.601   0.549 </span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a><span class="do">## 7 pressure                     -0.162      0.123    -1.32    0.190 </span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a><span class="do">## 8 cloudCover_scaled            -0.0691     0.0829   -0.833   0.406 </span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a><span class="do">## 9 windSpeed:cloudCover_scaled  -0.00688    0.0196   -0.351   0.726</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We have some strange new regression coefficients now. We have two coefficients for wind speed: <code>windSpeed</code> and <code>I(windSpeed^2)</code>. We also have a coefficient for the interaction term <code>windspeed:cloudCover_scaled</code>. <strong>We cannot interpret these individually</strong>. If we want to know the effect of wind speed on high temperatures, we have to incorporate all three of these new coefficients simultaneously. Fortunately <code>predictions()</code> and <code>slopes()</code> both handle that for us automatically.</p>
<p>Let’s plot the predictions to see that everything is more curvy now (and differently curved across different levels of cloud cover).</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>predicted_values_wild <span class="ot">&lt;-</span> <span class="fu">predictions</span>(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  model_wild, </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">datagrid</span>(<span class="at">windSpeed =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">8</span>, <span class="fl">0.5</span>),</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">cloudCover_scaled =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">33</span>, <span class="dv">66</span>, <span class="dv">100</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make cloud cover a categorical variable so we can facet with it</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cloudCover_scaled =</span> <span class="fu">factor</span>(cloudCover_scaled))</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predicted_values_wild, <span class="fu">aes</span>(<span class="at">x =</span> windSpeed, <span class="at">y =</span> estimate)) <span class="sc">+</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high, <span class="at">fill =</span> cloudCover_scaled),</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> cloudCover_scaled), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Wind speed (MPH)"</span>, <span class="at">y =</span> <span class="st">"Predicted high temperature (F)"</span>) <span class="sc">+</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="st">"none"</span>, <span class="at">color =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(cloudCover_scaled), <span class="at">nrow =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="07-example_files/figure-html/mfx-predictions-wild-1.png" class="img-fluid figure-img" width="864"></p>
</figure>
</div>
</div>
</div>
<p>That’s neat! At all the different levels of cloud cover, the wind speed trend is fairly shallow (and even pretty flat when cloud cover is 0 or 33) at low levels of wind speed. The line drops fairly quickly as wind speed increases though. Let’s get some exact numbers with <code>marginaleffects()</code>:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">slopes</span>(model_wild, </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">datagrid</span>(<span class="at">windSpeed =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>),</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">cloudCover_scaled =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">33</span>, <span class="dv">66</span>, <span class="dv">100</span>)), </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"windSpeed"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This creates a ton of extra columns so we'll just look at a few</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(term, windSpeed, estimate, std.error, p.value, conf.low, conf.high, predicted)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="do">##       Term Estimate Std. Error Pr(&gt;|z|) CI low CI high</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="do">##  windSpeed   -0.681      1.477   0.6449  -3.58  2.2145</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="do">##  windSpeed   -0.908      1.669   0.5864  -4.18  2.3627</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="do">##  windSpeed   -1.135      2.050   0.5800  -5.15  2.8838</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="do">##  windSpeed   -1.368      2.561   0.5931  -6.39  3.6515</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="do">##  windSpeed   -1.475      0.694   0.0335  -2.83 -0.1150</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="do">##  windSpeed   -1.702      0.421   &lt;0.001  -2.53 -0.8755</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="do">##  windSpeed   -1.928      0.837   0.0212  -3.57 -0.2880</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="do">##  windSpeed   -2.162      1.462   0.1391  -5.03  0.7030</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="do">##  windSpeed   -2.268      1.801   0.2078  -5.80  1.2613</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a><span class="do">##  windSpeed   -2.495      1.434   0.0817  -5.31  0.3144</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="do">##  windSpeed   -2.722      1.305   0.0369  -5.28 -0.1651</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="do">##  windSpeed   -2.956      1.488   0.0470  -5.87 -0.0394</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a><span class="do">## Columns: term, windSpeed, estimate, std.error, p.value, conf.low, conf.high, predicted</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Phew, we have 12 different slopes here. Let’s talk through a few of them to get the intuition. If cloud cover is 0 and wind speed is 2 MPH, moving from 2 to 3 MPH is associated with a -0.68° decrease in high temperature on average (see the <code>estimate</code> column in the first row in the table). If the existing wind speed is 6 MPH, moving from 6 to 7 is associated with a -2.27° decrease in high temperature on average (see the <code>estimate</code> column in the 9th row of the table). The slope is steeper and more negative when the wind is faster, so changes in temperature are more dramatic. Because we have an interaction with cloud cover, the slope also changes at different levels of cloud cover. At 2 MPH of wind, the slope is -0.68° when cloud cover is 0 (first row), but -1.37° when cloud cover is 100 (4th row).</p>
<p>Finally, we can visualize how these slopes change across wind speed and cloud cover by plotting them:</p>
<div class="cell" data-layout-align="center">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>slopes_wild <span class="ot">&lt;-</span> <span class="fu">slopes</span>(</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  model_wild, </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">datagrid</span>(<span class="at">windSpeed =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">6</span>, <span class="at">by =</span> <span class="fl">0.1</span>),</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">cloudCover_scaled =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">33</span>, <span class="dv">66</span>, <span class="dv">100</span>)), </span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"windSpeed"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cloudCover_scaled =</span> <span class="fu">factor</span>(cloudCover_scaled))</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(slopes_wild, <span class="fu">aes</span>(<span class="at">x =</span> windSpeed, <span class="at">y =</span> estimate)) <span class="sc">+</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high, <span class="at">fill =</span> cloudCover_scaled),</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> cloudCover_scaled), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Wind speed (MPH)"</span>, <span class="at">y =</span> <span class="st">"Slope (marginal effect) of wind speed"</span>,</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Marginal effect of wind speed across levels of cloud cover"</span>,</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"These are *slopes*, not predicted values"</span>) <span class="sc">+</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="st">"none"</span>, <span class="at">color =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(cloudCover_scaled), <span class="at">nrow =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="07-example_files/figure-html/plot-mfx-slopes-wild-1.png" class="img-fluid figure-img" width="864"></p>
</figure>
</div>
</div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../example/06-example.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">6: Uncertainty</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../example/08-example.html" class="pagination-link">
        <span class="nav-page-text">8: Comparisons</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb40" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Relationships"</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "2024-03-18"</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="an">date_end:</span><span class="co"> "2024-03-22"</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>For this example, we're going to use historical weather data from the now-defunct <span class="co">[</span><span class="ot">Dark Sky</span><span class="co">](https://darksky.net/forecast/33.7546,-84.39/us12/en)</span> about wind speed and temperature trends for downtown Atlanta (<span class="co">[</span><span class="ot">specifically `33.754557, -84.390009`</span><span class="co">](https://www.google.com/maps/place/33°45'16.4"N+84°23'24.0"W/@33.754557,-84.3921977,17z/)</span>) in 2019. I downloaded this data using Dark Sky's (now-retired-because-they-were-bought-by-Apple) API using the <span class="co">[</span><span class="ot"> {darksky} package</span><span class="co">](https://github.com/hrbrmstr/darksky)</span>.</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>If you want to follow along with this example, you can download the data below (you'll likely need to right click and choose "Save Link As…"):</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">{{&lt; fa file-csv &gt;}} `atl-weather-2019.csv`</span><span class="co">](/files/data/external_data/atl-weather-2019.csv)</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="fu">## Live coding example</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;div</span> <span class="er">class</span><span class="ot">=</span><span class="st">"ratio ratio-16x9"</span><span class="kw">&gt;</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;iframe</span> <span class="er">src</span><span class="ot">=</span><span class="st">"https://www.youtube.com/embed/zfEAmJzfbkE"</span> <span class="er">allow</span><span class="ot">=</span><span class="st">"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"</span> <span class="er">allowfullscreen</span><span class="ot">=</span><span class="st">""</span> <span class="er">frameborder</span><span class="ot">=</span><span class="st">"0"</span><span class="kw">&gt;&lt;/iframe&gt;</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/div&gt;</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a><span class="fu">### Slight differences from the video</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>This is a slightly cleaned up version of the code from the video.</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">fig.width =</span> <span class="dv">6</span>, <span class="at">fig.height =</span> <span class="fl">3.6</span>, <span class="at">fig.align =</span> <span class="st">"center"</span>, <span class="at">collapse =</span> <span class="cn">TRUE</span>)</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="st">"digits"</span> <span class="ot">=</span> <span class="dv">2</span>, <span class="st">"width"</span> <span class="ot">=</span> <span class="dv">150</span>)</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a><span class="fu">## Load and clean data</span></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>First, we load the libraries we'll be using:</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load-libraries, message=FALSE, warning=FALSE}</span></span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)  <span class="co"># For ggplot, dplyr, and friends</span></span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)  <span class="co"># For combining ggplot plots</span></span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GGally)     <span class="co"># For scatterplot matrices</span></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)      <span class="co"># For converting model objects to data frames</span></span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>Then we load the data with <span class="in">`read_csv()`</span>. Here I assume that the CSV file lives in a subfolder in my project named <span class="in">`data`</span>:</span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load-data-fake, eval=FALSE}</span></span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>weather_atl <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/atl-weather-2019.csv"</span>)</span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load-data-real, include=FALSE, message=FALSE}</span></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>weather_atl <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"files"</span>, <span class="st">"data"</span>, <span class="st">"external_data"</span>, <span class="st">"atl-weather-2019.csv"</span>))</span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a><span class="fu">## Legal dual y-axes</span></span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a>It is fine (and often helpful!) to use two y-axes if the two different scales measure the same thing, like counts and percentages, Fahrenheit and Celsius, pounds and kilograms, inches and centimeters, etc.</span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a>To do this, you need to add an argument (<span class="in">`sec.axis`</span>) to <span class="in">`scale_y_continuous()`</span> to tell it to use a second axis. This <span class="in">`sec.axis`</span> argument takes a <span class="in">`sec_axis()`</span> function that tells ggplot how to transform the scale. You need to specify a formula or function that defines how the original axis gets transformed. This formula uses a special syntax. It needs to start with a <span class="in">`~`</span>, which indicates that it's a function, and it needs to use <span class="in">`.`</span> to stand in for the original value in the original axis. </span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a>Since the equation for converting Fahrenheit to Celsius is this…</span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a>\text{C} = (32 - \text{F}) \times -\frac{5}{9}</span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a>…we can specify this with code like so (where <span class="in">`.`</span> stands for the Fahrenheit value):</span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a><span class="in">```default</span></span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a><span class="in">~ (32 - .) * -5 / 9</span></span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a>Here's a plot of daily high temperatures in Atlanta throughout 2019, with a second axis:</span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true" tabindex="-1"></a><span class="in">```{r atl-weather-dual-axes}</span></span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(weather_atl, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> temperatureHigh)) <span class="sc">+</span></span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb40-76"><a href="#cb40-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="at">trans =</span> <span class="sc">~</span> (<span class="dv">32</span> <span class="sc">-</span> .) <span class="sc">*</span> <span class="sc">-</span><span class="dv">5</span><span class="sc">/</span><span class="dv">9</span>,</span>
<span id="cb40-77"><a href="#cb40-77" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">name =</span> <span class="st">"Celsius"</span>)) <span class="sc">+</span></span>
<span id="cb40-78"><a href="#cb40-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Fahrenheit"</span>) <span class="sc">+</span></span>
<span id="cb40-79"><a href="#cb40-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb40-80"><a href="#cb40-80" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-81"><a href="#cb40-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-82"><a href="#cb40-82" aria-hidden="true" tabindex="-1"></a>For fun, we could also convert it to Kelvin, which uses this formula:</span>
<span id="cb40-83"><a href="#cb40-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-84"><a href="#cb40-84" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-85"><a href="#cb40-85" aria-hidden="true" tabindex="-1"></a>\text{K} = (\text{F} - 32) \times \frac{5}{9} + 273.15</span>
<span id="cb40-86"><a href="#cb40-86" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-87"><a href="#cb40-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-88"><a href="#cb40-88" aria-hidden="true" tabindex="-1"></a><span class="in">```{r atl-weather-dual-axes-kelvin}</span></span>
<span id="cb40-89"><a href="#cb40-89" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(weather_atl, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> temperatureHigh)) <span class="sc">+</span></span>
<span id="cb40-90"><a href="#cb40-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb40-91"><a href="#cb40-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="at">trans =</span> <span class="sc">~</span> (. <span class="sc">-</span> <span class="dv">32</span>) <span class="sc">*</span> <span class="dv">5</span><span class="sc">/</span><span class="dv">9</span> <span class="sc">+</span> <span class="fl">273.15</span>,</span>
<span id="cb40-92"><a href="#cb40-92" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">name =</span> <span class="st">"Kelvin"</span>)) <span class="sc">+</span></span>
<span id="cb40-93"><a href="#cb40-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Fahrenheit"</span>) <span class="sc">+</span></span>
<span id="cb40-94"><a href="#cb40-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb40-95"><a href="#cb40-95" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-96"><a href="#cb40-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-97"><a href="#cb40-97" aria-hidden="true" tabindex="-1"></a><span class="fu">## Combining plots</span></span>
<span id="cb40-98"><a href="#cb40-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-99"><a href="#cb40-99" aria-hidden="true" tabindex="-1"></a>A good alternative to using two y-axes is to use two plots instead. The <span class="co">[</span><span class="ot">{patchwork} package</span><span class="co">](https://github.com/thomasp85/patchwork)</span> makes this *really* easy to do with R. There are other similar packages that do this, like {cowplot} and {gridExtra}, but I've found that {patchwork} is the easiest to use *and* it actually aligns the different plot elements like axis lines and legends (yay alignment in CRAP!). The <span class="co">[</span><span class="ot">documentation for {patchwork}</span><span class="co">](https://patchwork.data-imaginist.com/articles/guides/assembly.html)</span> is really great and full of examples—you should check it out to see all the things you can do with it!</span>
<span id="cb40-100"><a href="#cb40-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-101"><a href="#cb40-101" aria-hidden="true" tabindex="-1"></a>To use {patchwork}, we need to (1) save our plots as objects and (2) add them together with <span class="in">`+`</span>.</span>
<span id="cb40-102"><a href="#cb40-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-103"><a href="#cb40-103" aria-hidden="true" tabindex="-1"></a>For instance, is there a relationship between temperature and humidity in Atlanta? We can plot both:</span>
<span id="cb40-104"><a href="#cb40-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-105"><a href="#cb40-105" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-temp-humid-plots, message=FALSE}</span></span>
<span id="cb40-106"><a href="#cb40-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Temperature in Atlanta</span></span>
<span id="cb40-107"><a href="#cb40-107" aria-hidden="true" tabindex="-1"></a>temp_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(weather_atl, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> temperatureHigh)) <span class="sc">+</span></span>
<span id="cb40-108"><a href="#cb40-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb40-109"><a href="#cb40-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb40-110"><a href="#cb40-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="at">trans =</span> <span class="sc">~</span> (<span class="dv">32</span> <span class="sc">-</span> .) <span class="sc">*</span> <span class="sc">-</span><span class="dv">5</span><span class="sc">/</span><span class="dv">9</span>,</span>
<span id="cb40-111"><a href="#cb40-111" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">name =</span> <span class="st">"Celsius"</span>)) <span class="sc">+</span></span>
<span id="cb40-112"><a href="#cb40-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Fahrenheit"</span>) <span class="sc">+</span></span>
<span id="cb40-113"><a href="#cb40-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb40-114"><a href="#cb40-114" aria-hidden="true" tabindex="-1"></a>temp_plot</span>
<span id="cb40-115"><a href="#cb40-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-116"><a href="#cb40-116" aria-hidden="true" tabindex="-1"></a><span class="co"># Humidity in Atlanta</span></span>
<span id="cb40-117"><a href="#cb40-117" aria-hidden="true" tabindex="-1"></a>humidity_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(weather_atl, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> humidity)) <span class="sc">+</span></span>
<span id="cb40-118"><a href="#cb40-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb40-119"><a href="#cb40-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb40-120"><a href="#cb40-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Humidity"</span>) <span class="sc">+</span></span>
<span id="cb40-121"><a href="#cb40-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb40-122"><a href="#cb40-122" aria-hidden="true" tabindex="-1"></a>humidity_plot</span>
<span id="cb40-123"><a href="#cb40-123" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-124"><a href="#cb40-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-125"><a href="#cb40-125" aria-hidden="true" tabindex="-1"></a>Right now, these are two separate plots, but we can combine them with <span class="in">`+`</span> if we load {patchwork}:</span>
<span id="cb40-126"><a href="#cb40-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-127"><a href="#cb40-127" aria-hidden="true" tabindex="-1"></a><span class="in">```{r patchwork-first, message=FALSE}</span></span>
<span id="cb40-128"><a href="#cb40-128" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb40-129"><a href="#cb40-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-130"><a href="#cb40-130" aria-hidden="true" tabindex="-1"></a>temp_plot <span class="sc">+</span> humidity_plot</span>
<span id="cb40-131"><a href="#cb40-131" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-132"><a href="#cb40-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-133"><a href="#cb40-133" aria-hidden="true" tabindex="-1"></a>By default, {patchwork} will put these side-by-side, but we can change that with the <span class="in">`plot_layout()`</span> function:</span>
<span id="cb40-134"><a href="#cb40-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-135"><a href="#cb40-135" aria-hidden="true" tabindex="-1"></a><span class="in">```{r patchwork-vertical, message=FALSE}</span></span>
<span id="cb40-136"><a href="#cb40-136" aria-hidden="true" tabindex="-1"></a>temp_plot <span class="sc">+</span> humidity_plot <span class="sc">+</span></span>
<span id="cb40-137"><a href="#cb40-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb40-138"><a href="#cb40-138" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-139"><a href="#cb40-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-140"><a href="#cb40-140" aria-hidden="true" tabindex="-1"></a>We can also play with other arguments in <span class="in">`plot_layout()`</span>. If we want to make the temperature plot taller and shrink the humidity section, we can specify the proportions for the plot heights. Here, the temperature plot is 70% of the height and the humidity plot is 30%:</span>
<span id="cb40-141"><a href="#cb40-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-142"><a href="#cb40-142" aria-hidden="true" tabindex="-1"></a><span class="in">```{r patchwork-vertical-resized, message=FALSE}</span></span>
<span id="cb40-143"><a href="#cb40-143" aria-hidden="true" tabindex="-1"></a>temp_plot <span class="sc">+</span> humidity_plot <span class="sc">+</span></span>
<span id="cb40-144"><a href="#cb40-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">heights =</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">0.3</span>))</span>
<span id="cb40-145"><a href="#cb40-145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-146"><a href="#cb40-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-147"><a href="#cb40-147" aria-hidden="true" tabindex="-1"></a><span class="fu">## Scatterplot matrices</span></span>
<span id="cb40-148"><a href="#cb40-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-149"><a href="#cb40-149" aria-hidden="true" tabindex="-1"></a>We can visualize the correlations between pairs of variables with the <span class="in">`ggpairs()`</span> function in the {GGally} package. For instance, how correlated are high and low temperatures, humidity, wind speed, and the chance of precipitation? We first make a smaller dataset with just those columns, and then we feed that dataset into <span class="in">`ggpairs()`</span> to see all the correlation information:</span>
<span id="cb40-150"><a href="#cb40-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-151"><a href="#cb40-151" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ggpairs, fig.width=9, fig.height=6}</span></span>
<span id="cb40-152"><a href="#cb40-152" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GGally)</span>
<span id="cb40-153"><a href="#cb40-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-154"><a href="#cb40-154" aria-hidden="true" tabindex="-1"></a>weather_correlations <span class="ot">&lt;-</span> weather_atl <span class="sc">%&gt;%</span> </span>
<span id="cb40-155"><a href="#cb40-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(temperatureHigh, temperatureLow, humidity, windSpeed, precipProbability)</span>
<span id="cb40-156"><a href="#cb40-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-157"><a href="#cb40-157" aria-hidden="true" tabindex="-1"></a><span class="fu">ggpairs</span>(weather_correlations)</span>
<span id="cb40-158"><a href="#cb40-158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-159"><a href="#cb40-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-160"><a href="#cb40-160" aria-hidden="true" tabindex="-1"></a>It looks like high and low temperatures are extremely highly positively correlated (r = 0.92). Wind spped and temperature are moderately negatively correlated, with low temperatures having a stronger negative correlation (r = -0.45). There's no correlation whatsoever between low temperatures and the precipitation probability (r = -0.03) or humidity and high temperatures (r = -0.03).</span>
<span id="cb40-161"><a href="#cb40-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-162"><a href="#cb40-162" aria-hidden="true" tabindex="-1"></a>Even though <span class="in">`ggpairs()`</span> doesn't use the standard <span class="in">`ggplot(...) + geom_whatever()`</span> syntax we're familiar with, it does behind the scenes, so you can add regular ggplot layers to it:</span>
<span id="cb40-163"><a href="#cb40-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-164"><a href="#cb40-164" aria-hidden="true" tabindex="-1"></a><span class="in">```{r ggpairs-layers, eval=FALSE}</span></span>
<span id="cb40-165"><a href="#cb40-165" aria-hidden="true" tabindex="-1"></a><span class="fu">ggpairs</span>(weather_correlations) <span class="sc">+</span></span>
<span id="cb40-166"><a href="#cb40-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Correlations!"</span>) <span class="sc">+</span></span>
<span id="cb40-167"><a href="#cb40-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dark</span>()</span>
<span id="cb40-168"><a href="#cb40-168" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-169"><a href="#cb40-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-170"><a href="#cb40-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-171"><a href="#cb40-171" aria-hidden="true" tabindex="-1"></a><span class="fu">## Correlograms</span></span>
<span id="cb40-172"><a href="#cb40-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-173"><a href="#cb40-173" aria-hidden="true" tabindex="-1"></a>Scatterplot matrices typically include way too much information to be used in actual publications. I use them when doing my own analysis just to see how different variables are related, but I rarely polish them up for public consumption. In the readings for this week, Claus Wilke showed a type of plot called a <span class="co">[</span><span class="ot">*correlogram*</span><span class="co">](https://clauswilke.com/dataviz/visualizing-associations.html#associations-correlograms)</span> which *is* more appropriate for publication. </span>
<span id="cb40-174"><a href="#cb40-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-175"><a href="#cb40-175" aria-hidden="true" tabindex="-1"></a>These are essentially heatmaps of the different correlation coefficients. To make these with ggplot, we need to do a little bit of extra data processing, mostly to reshape data into a long, tidy format that we can plot. Here's how.</span>
<span id="cb40-176"><a href="#cb40-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-177"><a href="#cb40-177" aria-hidden="true" tabindex="-1"></a>First we need to build a correlation matrix of the main variables we care about. Ordinarily the <span class="in">`cor()`</span> function in R takes two arguments—x and y—and it will return a single correlation value. If you feed a data frame into <span class="in">`cor()`</span> though, it'll calculate the correlation between each pair of columns</span>
<span id="cb40-178"><a href="#cb40-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-179"><a href="#cb40-179" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-cor-mat, width=150}</span></span>
<span id="cb40-180"><a href="#cb40-180" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a correlation matrix</span></span>
<span id="cb40-181"><a href="#cb40-181" aria-hidden="true" tabindex="-1"></a>things_to_correlate <span class="ot">&lt;-</span> weather_atl <span class="sc">%&gt;%</span> </span>
<span id="cb40-182"><a href="#cb40-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(temperatureHigh, temperatureLow, humidity, windSpeed, precipProbability) <span class="sc">%&gt;%</span> </span>
<span id="cb40-183"><a href="#cb40-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>()</span>
<span id="cb40-184"><a href="#cb40-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-185"><a href="#cb40-185" aria-hidden="true" tabindex="-1"></a>things_to_correlate</span>
<span id="cb40-186"><a href="#cb40-186" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-187"><a href="#cb40-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-188"><a href="#cb40-188" aria-hidden="true" tabindex="-1"></a>The two halves of this matrix (split along the diagonal line) are identical, so we can remove the lower triangle with this code (which will set all the cells in the lower triangle to <span class="in">`NA`</span>):</span>
<span id="cb40-189"><a href="#cb40-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-190"><a href="#cb40-190" aria-hidden="true" tabindex="-1"></a><span class="in">```{r remove-lower-tri}</span></span>
<span id="cb40-191"><a href="#cb40-191" aria-hidden="true" tabindex="-1"></a><span class="co"># Get rid of the lower triangle</span></span>
<span id="cb40-192"><a href="#cb40-192" aria-hidden="true" tabindex="-1"></a>things_to_correlate[<span class="fu">lower.tri</span>(things_to_correlate)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb40-193"><a href="#cb40-193" aria-hidden="true" tabindex="-1"></a>things_to_correlate</span>
<span id="cb40-194"><a href="#cb40-194" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-195"><a href="#cb40-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-196"><a href="#cb40-196" aria-hidden="true" tabindex="-1"></a>Finally, in order to plot this, the data needs to be in tidy (or long) format. Here we convert the <span class="in">`things_to_correlate`</span> matrix into a data frame, add a column for the row names, take all the columns and put them into a single column named <span class="in">`measure1`</span>, and take all the correlation numbers and put them in a column named <span class="in">`cor`</span> In the end, we make sure the measure variables are ordered by their order of appearance (otherwise they plot alphabetically and don't make a triangle)</span>
<span id="cb40-197"><a href="#cb40-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-198"><a href="#cb40-198" aria-hidden="true" tabindex="-1"></a><span class="in">```{r cor-tidy}</span></span>
<span id="cb40-199"><a href="#cb40-199" aria-hidden="true" tabindex="-1"></a>things_to_correlate_long <span class="ot">&lt;-</span> things_to_correlate <span class="sc">%&gt;%</span> </span>
<span id="cb40-200"><a href="#cb40-200" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert from a matrix to a data frame</span></span>
<span id="cb40-201"><a href="#cb40-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb40-202"><a href="#cb40-202" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Matrixes have column names that don't get converted to columns when using</span></span>
<span id="cb40-203"><a href="#cb40-203" aria-hidden="true" tabindex="-1"></a>  <span class="co"># as.data.frame(), so this adds those names as a column</span></span>
<span id="cb40-204"><a href="#cb40-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">"measure2"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb40-205"><a href="#cb40-205" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make this long. Take all the columns except measure2 and put their names in</span></span>
<span id="cb40-206"><a href="#cb40-206" aria-hidden="true" tabindex="-1"></a>  <span class="co"># a column named measure1 and their values in a column named cor</span></span>
<span id="cb40-207"><a href="#cb40-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>measure2,</span>
<span id="cb40-208"><a href="#cb40-208" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"measure1"</span>,</span>
<span id="cb40-209"><a href="#cb40-209" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"cor"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb40-210"><a href="#cb40-210" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make a new column with the rounded version of the correlation value</span></span>
<span id="cb40-211"><a href="#cb40-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">nice_cor =</span> <span class="fu">round</span>(cor, <span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb40-212"><a href="#cb40-212" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove rows where the two measures are the same (like the correlation</span></span>
<span id="cb40-213"><a href="#cb40-213" aria-hidden="true" tabindex="-1"></a>  <span class="co"># between humidity and humidity)</span></span>
<span id="cb40-214"><a href="#cb40-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(measure2 <span class="sc">!=</span> measure1) <span class="sc">%&gt;%</span></span>
<span id="cb40-215"><a href="#cb40-215" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get rid of the empty triangle</span></span>
<span id="cb40-216"><a href="#cb40-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(cor)) <span class="sc">%&gt;%</span> </span>
<span id="cb40-217"><a href="#cb40-217" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Put these categories in order</span></span>
<span id="cb40-218"><a href="#cb40-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">measure1 =</span> <span class="fu">fct_inorder</span>(measure1),</span>
<span id="cb40-219"><a href="#cb40-219" aria-hidden="true" tabindex="-1"></a>         <span class="at">measure2 =</span> <span class="fu">fct_inorder</span>(measure2))</span>
<span id="cb40-220"><a href="#cb40-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-221"><a href="#cb40-221" aria-hidden="true" tabindex="-1"></a>things_to_correlate_long</span>
<span id="cb40-222"><a href="#cb40-222" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-223"><a href="#cb40-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-224"><a href="#cb40-224" aria-hidden="true" tabindex="-1"></a>Phew. With the data all tidied like that, we can make a correlogram with a heatmap. This is just like <span class="co">[</span><span class="ot">the heatmap you made in session 4</span><span class="co">](https://datavizm20.classes.andrewheiss.com/example/04-example/#heatmap)</span>, but here we manipulate the fill scale a little so that it's diverging with three colors: a high value, a midpoint value, and a low value.</span>
<span id="cb40-225"><a href="#cb40-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-226"><a href="#cb40-226" aria-hidden="true" tabindex="-1"></a><span class="in">```{r cor-heatmap, fig.width=5, fig.height=5}</span></span>
<span id="cb40-227"><a href="#cb40-227" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(things_to_correlate_long, </span>
<span id="cb40-228"><a href="#cb40-228" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> measure2, <span class="at">y =</span> measure1, <span class="at">fill =</span> cor)) <span class="sc">+</span></span>
<span id="cb40-229"><a href="#cb40-229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb40-230"><a href="#cb40-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> nice_cor)) <span class="sc">+</span></span>
<span id="cb40-231"><a href="#cb40-231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="at">low =</span> <span class="st">"#E16462"</span>, <span class="at">mid =</span> <span class="st">"white"</span>, <span class="at">high =</span> <span class="st">"#0D0887"</span>,</span>
<span id="cb40-232"><a href="#cb40-232" aria-hidden="true" tabindex="-1"></a>                       <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb40-233"><a href="#cb40-233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb40-234"><a href="#cb40-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb40-235"><a href="#cb40-235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb40-236"><a href="#cb40-236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span>
<span id="cb40-237"><a href="#cb40-237" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-238"><a href="#cb40-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-239"><a href="#cb40-239" aria-hidden="true" tabindex="-1"></a>Instead of using a heatmap, we can also use points, which encode the correlation information both as color *and* as size. To do that, we just need to switch <span class="in">`geom_tile()`</span> to <span class="in">`geom_point()`</span> and set the <span class="in">`size = cor`</span> mapping:</span>
<span id="cb40-240"><a href="#cb40-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-241"><a href="#cb40-241" aria-hidden="true" tabindex="-1"></a><span class="in">```{r cor-points, fig.width=5, fig.height=5}</span></span>
<span id="cb40-242"><a href="#cb40-242" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(things_to_correlate_long, </span>
<span id="cb40-243"><a href="#cb40-243" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> measure2, <span class="at">y =</span> measure1, <span class="at">color =</span> cor)) <span class="sc">+</span></span>
<span id="cb40-244"><a href="#cb40-244" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Size by the absolute value so that -0.7 and 0.7 are the same size</span></span>
<span id="cb40-245"><a href="#cb40-245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> <span class="fu">abs</span>(cor))) <span class="sc">+</span></span>
<span id="cb40-246"><a href="#cb40-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient2</span>(<span class="at">low =</span> <span class="st">"#E16462"</span>, <span class="at">mid =</span> <span class="st">"white"</span>, <span class="at">high =</span> <span class="st">"#0D0887"</span>,</span>
<span id="cb40-247"><a href="#cb40-247" aria-hidden="true" tabindex="-1"></a>                        <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb40-248"><a href="#cb40-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_area</span>(<span class="at">max_size =</span> <span class="dv">15</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb40-249"><a href="#cb40-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb40-250"><a href="#cb40-250" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb40-251"><a href="#cb40-251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb40-252"><a href="#cb40-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span>
<span id="cb40-253"><a href="#cb40-253" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-254"><a href="#cb40-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-255"><a href="#cb40-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-256"><a href="#cb40-256" aria-hidden="true" tabindex="-1"></a><span class="fu">## Simple regression</span></span>
<span id="cb40-257"><a href="#cb40-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-258"><a href="#cb40-258" aria-hidden="true" tabindex="-1"></a>We can also visualize the relationships between variables using regression. Simple regression is easy to visualize, since you're only working with an X and a Y. For instance, what's the relationship between humidity and high temperatures during the summer?</span>
<span id="cb40-259"><a href="#cb40-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-260"><a href="#cb40-260" aria-hidden="true" tabindex="-1"></a>First, let's filter the data to only look at the summer. We also add a column to scale up the humidity value—right now it's on a scale of 0-1 (for percentages), but when interpreting regression we talk about increases in whole units, so we'd talk about moving from 0% humidity to 100% humidity, which isn't helpful, so instead we multiply everything by 100 so we can talk about moving from 50% humidity to 51% humidity. We also scale up a couple other variables that we'll use in the larger model later.</span>
<span id="cb40-261"><a href="#cb40-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-262"><a href="#cb40-262" aria-hidden="true" tabindex="-1"></a><span class="in">```{r subset-summer}</span></span>
<span id="cb40-263"><a href="#cb40-263" aria-hidden="true" tabindex="-1"></a>weather_atl_summer <span class="ot">&lt;-</span> weather_atl <span class="sc">%&gt;%</span> </span>
<span id="cb40-264"><a href="#cb40-264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(time <span class="sc">&gt;=</span> <span class="st">"2019-05-01"</span>, time <span class="sc">&lt;=</span> <span class="st">"2019-09-30"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb40-265"><a href="#cb40-265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">humidity_scaled =</span> humidity <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb40-266"><a href="#cb40-266" aria-hidden="true" tabindex="-1"></a>         <span class="at">moonPhase_scaled =</span> moonPhase <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb40-267"><a href="#cb40-267" aria-hidden="true" tabindex="-1"></a>         <span class="at">precipProbability_scaled =</span> precipProbability <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb40-268"><a href="#cb40-268" aria-hidden="true" tabindex="-1"></a>         <span class="at">cloudCover_scaled =</span> cloudCover <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb40-269"><a href="#cb40-269" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-270"><a href="#cb40-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-271"><a href="#cb40-271" aria-hidden="true" tabindex="-1"></a>Then we can build a simple regression model:</span>
<span id="cb40-272"><a href="#cb40-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-273"><a href="#cb40-273" aria-hidden="true" tabindex="-1"></a><span class="in">```{r simple-model, message=FALSE}</span></span>
<span id="cb40-274"><a href="#cb40-274" aria-hidden="true" tabindex="-1"></a>model_simple <span class="ot">&lt;-</span> <span class="fu">lm</span>(temperatureHigh <span class="sc">~</span> humidity_scaled, </span>
<span id="cb40-275"><a href="#cb40-275" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> weather_atl_summer)</span>
<span id="cb40-276"><a href="#cb40-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-277"><a href="#cb40-277" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_simple, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span>
<span id="cb40-278"><a href="#cb40-278" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-279"><a href="#cb40-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-280"><a href="#cb40-280" aria-hidden="true" tabindex="-1"></a>We can interpret these coefficients like so:</span>
<span id="cb40-281"><a href="#cb40-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-282"><a href="#cb40-282" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The intercept shows that the average temperature when there's 0% humidity is 104°. There are no days with 0% humidity though, so we can ignore the intercept—it's really just here so that we can draw the line.</span>
<span id="cb40-283"><a href="#cb40-283" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The coefficient for <span class="in">`humidity_scaled`</span> shows that a one percent increase in humidity is associated with a 0.241° decrease in temperature, on average.</span>
<span id="cb40-284"><a href="#cb40-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-285"><a href="#cb40-285" aria-hidden="true" tabindex="-1"></a>Visualizing this model is simple, since there are only two variables:</span>
<span id="cb40-286"><a href="#cb40-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-287"><a href="#cb40-287" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-simple-model, warning=FALSE}</span></span>
<span id="cb40-288"><a href="#cb40-288" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(weather_atl_summer,</span>
<span id="cb40-289"><a href="#cb40-289" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> humidity_scaled, <span class="at">y =</span> temperatureHigh)) <span class="sc">+</span></span>
<span id="cb40-290"><a href="#cb40-290" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb40-291"><a href="#cb40-291" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>)</span>
<span id="cb40-292"><a href="#cb40-292" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-293"><a href="#cb40-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-294"><a href="#cb40-294" aria-hidden="true" tabindex="-1"></a>And indeed, as humidity increases, temperatures decrease.</span>
<span id="cb40-295"><a href="#cb40-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-296"><a href="#cb40-296" aria-hidden="true" tabindex="-1"></a><span class="fu">## Coefficient plots</span></span>
<span id="cb40-297"><a href="#cb40-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-298"><a href="#cb40-298" aria-hidden="true" tabindex="-1"></a>But if we use multiple variables in the model, it gets really hard to visualize the results since we're working with multiple dimensions. Instead, we can use coefficient plots to see the individual coefficients in the model.</span>
<span id="cb40-299"><a href="#cb40-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-300"><a href="#cb40-300" aria-hidden="true" tabindex="-1"></a>First, let's build a more complex model:</span>
<span id="cb40-301"><a href="#cb40-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-302"><a href="#cb40-302" aria-hidden="true" tabindex="-1"></a><span class="in">```{r complex-model}</span></span>
<span id="cb40-303"><a href="#cb40-303" aria-hidden="true" tabindex="-1"></a>model_complex <span class="ot">&lt;-</span> <span class="fu">lm</span>(temperatureHigh <span class="sc">~</span> humidity_scaled <span class="sc">+</span> moonPhase_scaled <span class="sc">+</span> </span>
<span id="cb40-304"><a href="#cb40-304" aria-hidden="true" tabindex="-1"></a>                      precipProbability_scaled <span class="sc">+</span> windSpeed <span class="sc">+</span> pressure <span class="sc">+</span> cloudCover_scaled,</span>
<span id="cb40-305"><a href="#cb40-305" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> weather_atl_summer)</span>
<span id="cb40-306"><a href="#cb40-306" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_complex, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span>
<span id="cb40-307"><a href="#cb40-307" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-308"><a href="#cb40-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-309"><a href="#cb40-309" aria-hidden="true" tabindex="-1"></a>We can interpret these coefficients like so:</span>
<span id="cb40-310"><a href="#cb40-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-311"><a href="#cb40-311" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Holding everything else constant, a 1% increase in humidity is associated with a 0.11° decrease in the high temperature, on average, but the effect is not statistically significant</span>
<span id="cb40-312"><a href="#cb40-312" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Holding everything else constant, a 1% increase in moon visibility is associated with a 0.01° increase in the high temperature, on average, and the effect is not statistically significant</span>
<span id="cb40-313"><a href="#cb40-313" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Holding everything else constant, a 1% increase in the probability of precipitation is associated with a 0.04° increase in the high temperature, on average, and the effect is not statistically significant</span>
<span id="cb40-314"><a href="#cb40-314" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Holding everything else constant, a 1 mph increase in the wind speed is associated with a 1.8° decrease in the high temperature, on average, and the effect *is* statistically significant</span>
<span id="cb40-315"><a href="#cb40-315" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Holding everything else constant, a 1 unit increase in barometric pressure is associated with a 0.15° decrease in the high temperature, on average, and the effect is not statistically significant</span>
<span id="cb40-316"><a href="#cb40-316" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Holding everything else constant, a 1% increase in cloud cover is associated with a 0.01° decrease in the high temperature, on average, and the effect *is* statistically significant</span>
<span id="cb40-317"><a href="#cb40-317" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The intercept is pretty useless. It shows that the predicted temperature will be 262° when humidity is 0%, the moon is invisible, there's no chance of precipitation, no wind, no barometric pressure, and no cloud cover. Yikes.</span>
<span id="cb40-318"><a href="#cb40-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-319"><a href="#cb40-319" aria-hidden="true" tabindex="-1"></a>To plot all these things at once, we'll store the results of <span class="in">`tidy(model_complex)`</span> as a data frame, remove the useless intercept, and plot it using <span class="in">`geom_pointrange()`</span>:</span>
<span id="cb40-320"><a href="#cb40-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-321"><a href="#cb40-321" aria-hidden="true" tabindex="-1"></a><span class="in">```{r coef-plot}</span></span>
<span id="cb40-322"><a href="#cb40-322" aria-hidden="true" tabindex="-1"></a>model_tidied <span class="ot">&lt;-</span> <span class="fu">tidy</span>(model_complex, <span class="at">conf.int =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb40-323"><a href="#cb40-323" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">!=</span> <span class="st">"(Intercept)"</span>)</span>
<span id="cb40-324"><a href="#cb40-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-325"><a href="#cb40-325" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(model_tidied,</span>
<span id="cb40-326"><a href="#cb40-326" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> term)) <span class="sc">+</span></span>
<span id="cb40-327"><a href="#cb40-327" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>) <span class="sc">+</span></span>
<span id="cb40-328"><a href="#cb40-328" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high)) <span class="sc">+</span> </span>
<span id="cb40-329"><a href="#cb40-329" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Coefficient estimate"</span>, <span class="at">y =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb40-330"><a href="#cb40-330" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb40-331"><a href="#cb40-331" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-332"><a href="#cb40-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-333"><a href="#cb40-333" aria-hidden="true" tabindex="-1"></a>Neat! Now we can see how big these different coefficients are and how close they are to zero. Wind speed has a big significant effect on temperature. The others are all very close to zero.</span>
<span id="cb40-334"><a href="#cb40-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-335"><a href="#cb40-335" aria-hidden="true" tabindex="-1"></a><span class="fu">## Marginal effects plots</span></span>
<span id="cb40-336"><a href="#cb40-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-337"><a href="#cb40-337" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb40-338"><a href="#cb40-338" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2023 update!</span></span>
<span id="cb40-339"><a href="#cb40-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-340"><a href="#cb40-340" aria-hidden="true" tabindex="-1"></a>Since recording the video for this section, lots of things have changed in the R world to make finding predicted values and marginal effects *a lot* easier. (This is why I had you <span class="co">[</span><span class="ot">read my guide to marginal things</span><span class="co">](https://www.andrewheiss.com/blog/2022/05/20/marginalia/)</span> as part of the readings for this session.) <span class="co">[</span><span class="ot">The {marginaleffects} R package</span><span class="co">](https://vincentarelbundock.github.io/marginaleffects/)</span> makes it really nice and easy to get predicted values of an outcome while holding everything else constant—you don't need to plug values in manually anymore like this section shows.</span>
<span id="cb40-341"><a href="#cb40-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-342"><a href="#cb40-342" aria-hidden="true" tabindex="-1"></a>There's an example of using {marginaleffects} <span class="co">[</span><span class="ot">down below</span><span class="co">](#predicted-values-and-marginal-effects-in-2023)</span>.</span>
<span id="cb40-343"><a href="#cb40-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-344"><a href="#cb40-344" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb40-345"><a href="#cb40-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-346"><a href="#cb40-346" aria-hidden="true" tabindex="-1"></a>Instead of just looking at the coefficients, we can also see the effect of moving different variables up and down like sliders and switches. Remember that regression coefficients allow us to build actual mathematical formulas that predict the value of Y. The coefficients from <span class="in">`model_compex`</span> yield the following big hairy ugly equation:</span>
<span id="cb40-347"><a href="#cb40-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-348"><a href="#cb40-348" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-349"><a href="#cb40-349" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb40-350"><a href="#cb40-350" aria-hidden="true" tabindex="-1"></a>\hat{\text{High temperature}} =&amp; 262 - 0.11 \times \text{humidity<span class="sc">\_</span>scaled } <span class="sc">\\</span></span>
<span id="cb40-351"><a href="#cb40-351" aria-hidden="true" tabindex="-1"></a>&amp; + 0.01 \times \text{moonPhase<span class="sc">\_</span>scaled } + 0.04 \times \text{precipProbability<span class="sc">\_</span>scaled } <span class="sc">\\</span></span>
<span id="cb40-352"><a href="#cb40-352" aria-hidden="true" tabindex="-1"></a>&amp; - 1.78 \times \text{windSpeed} - 0.16 \times \text{pressure} - 0.095 \times \text{cloudCover<span class="sc">\_</span>scaled}</span>
<span id="cb40-353"><a href="#cb40-353" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb40-354"><a href="#cb40-354" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-355"><a href="#cb40-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-356"><a href="#cb40-356" aria-hidden="true" tabindex="-1"></a>If we plug in values for each of the explanatory variables, we can get the predicted value of high temperature, or $\hat{y}$.</span>
<span id="cb40-357"><a href="#cb40-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-358"><a href="#cb40-358" aria-hidden="true" tabindex="-1"></a>The <span class="in">`augment()`</span> function in the {broom} library allows us to take a data frame of explanatory variable values, plug them into the model equation, and get predictions out. For example, let's set each of the variables to some arbitrary values (50% for humidity, moon phase, chance of rain, and cloud cover; 1000 for pressure, and 1 MPH for wind speed).</span>
<span id="cb40-359"><a href="#cb40-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-360"><a href="#cb40-360" aria-hidden="true" tabindex="-1"></a><span class="in">```{r newdata-example}</span></span>
<span id="cb40-361"><a href="#cb40-361" aria-hidden="true" tabindex="-1"></a>newdata_example <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">humidity_scaled =</span> <span class="dv">50</span>, <span class="at">moonPhase_scaled =</span> <span class="dv">50</span>, </span>
<span id="cb40-362"><a href="#cb40-362" aria-hidden="true" tabindex="-1"></a>                          <span class="at">precipProbability_scaled =</span> <span class="dv">50</span>, <span class="at">windSpeed =</span> <span class="dv">1</span>, </span>
<span id="cb40-363"><a href="#cb40-363" aria-hidden="true" tabindex="-1"></a>                          <span class="at">pressure =</span> <span class="dv">1000</span>, <span class="at">cloudCover_scaled =</span> <span class="dv">50</span>)</span>
<span id="cb40-364"><a href="#cb40-364" aria-hidden="true" tabindex="-1"></a>newdata_example</span>
<span id="cb40-365"><a href="#cb40-365" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-366"><a href="#cb40-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-367"><a href="#cb40-367" aria-hidden="true" tabindex="-1"></a>We can plug these values into the model with <span class="in">`augment()`</span>. The <span class="in">`se_fit`</span> argument gives us standard errors for each prediction:</span>
<span id="cb40-368"><a href="#cb40-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-369"><a href="#cb40-369" aria-hidden="true" tabindex="-1"></a><span class="in">```{r augment-newdata-example}</span></span>
<span id="cb40-370"><a href="#cb40-370" aria-hidden="true" tabindex="-1"></a><span class="co"># I use select() here because augment() returns columns for all the explanatory</span></span>
<span id="cb40-371"><a href="#cb40-371" aria-hidden="true" tabindex="-1"></a><span class="co"># variables, and the .fitted column with the predicted value is on the far right</span></span>
<span id="cb40-372"><a href="#cb40-372" aria-hidden="true" tabindex="-1"></a><span class="co"># and gets cut off</span></span>
<span id="cb40-373"><a href="#cb40-373" aria-hidden="true" tabindex="-1"></a><span class="fu">augment</span>(model_complex, <span class="at">newdata =</span> newdata_example, <span class="at">se_fit =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb40-374"><a href="#cb40-374" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.fitted, .se.fit)</span>
<span id="cb40-375"><a href="#cb40-375" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-376"><a href="#cb40-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-377"><a href="#cb40-377" aria-hidden="true" tabindex="-1"></a>Given these weather conditions, the predicted high temperature is 96.2°. Now you're an armchair meteorologist!</span>
<span id="cb40-378"><a href="#cb40-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-379"><a href="#cb40-379" aria-hidden="true" tabindex="-1"></a>We can follow the same pattern to show how the predicted temperature changes as specific variables change across a whole range. Here, we create a data frame of possible wind speeds and keep all the other explanatory variables at their means:</span>
<span id="cb40-380"><a href="#cb40-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-381"><a href="#cb40-381" aria-hidden="true" tabindex="-1"></a><span class="in">```{r newdata-windspeed}</span></span>
<span id="cb40-382"><a href="#cb40-382" aria-hidden="true" tabindex="-1"></a>newdata <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">windSpeed =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">8</span>, <span class="fl">0.5</span>),</span>
<span id="cb40-383"><a href="#cb40-383" aria-hidden="true" tabindex="-1"></a>                  <span class="at">pressure =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>pressure),</span>
<span id="cb40-384"><a href="#cb40-384" aria-hidden="true" tabindex="-1"></a>                  <span class="at">precipProbability_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>precipProbability_scaled),</span>
<span id="cb40-385"><a href="#cb40-385" aria-hidden="true" tabindex="-1"></a>                  <span class="at">moonPhase_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>moonPhase_scaled),</span>
<span id="cb40-386"><a href="#cb40-386" aria-hidden="true" tabindex="-1"></a>                  <span class="at">humidity_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>humidity_scaled),</span>
<span id="cb40-387"><a href="#cb40-387" aria-hidden="true" tabindex="-1"></a>                  <span class="at">cloudCover_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>cloudCover_scaled))</span>
<span id="cb40-388"><a href="#cb40-388" aria-hidden="true" tabindex="-1"></a>newdata</span>
<span id="cb40-389"><a href="#cb40-389" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-390"><a href="#cb40-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-391"><a href="#cb40-391" aria-hidden="true" tabindex="-1"></a>If we feed this big data frame into <span class="in">`augment()`</span>, we can get the predicted high temperature for each row. We can also use the <span class="in">`.se.fit`</span> column to calculate the 95% confidence interval for each predicted value. We take the standard error, multiply it by -1.96 and 1.96 (or the quantile of the normal distribution at 2.5% and 97.5%), and add that value to the estimate.</span>
<span id="cb40-392"><a href="#cb40-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-393"><a href="#cb40-393" aria-hidden="true" tabindex="-1"></a><span class="in">```{r predicted-values-windspeed}</span></span>
<span id="cb40-394"><a href="#cb40-394" aria-hidden="true" tabindex="-1"></a>predicted_values <span class="ot">&lt;-</span> <span class="fu">augment</span>(model_complex, </span>
<span id="cb40-395"><a href="#cb40-395" aria-hidden="true" tabindex="-1"></a>                            <span class="at">newdata =</span> newdata,</span>
<span id="cb40-396"><a href="#cb40-396" aria-hidden="true" tabindex="-1"></a>                            <span class="at">se_fit =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb40-397"><a href="#cb40-397" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">conf.low =</span> .fitted <span class="sc">+</span> (<span class="sc">-</span><span class="fl">1.96</span> <span class="sc">*</span> .se.fit),</span>
<span id="cb40-398"><a href="#cb40-398" aria-hidden="true" tabindex="-1"></a>         <span class="at">conf.high =</span> .fitted <span class="sc">+</span> (<span class="fl">1.96</span> <span class="sc">*</span> .se.fit))</span>
<span id="cb40-399"><a href="#cb40-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-400"><a href="#cb40-400" aria-hidden="true" tabindex="-1"></a>predicted_values <span class="sc">%&gt;%</span> </span>
<span id="cb40-401"><a href="#cb40-401" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(windSpeed, .fitted, .se.fit, conf.low, conf.high) <span class="sc">%&gt;%</span> </span>
<span id="cb40-402"><a href="#cb40-402" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span>
<span id="cb40-403"><a href="#cb40-403" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-404"><a href="#cb40-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-405"><a href="#cb40-405" aria-hidden="true" tabindex="-1"></a>Cool! Just looking at the data in the table, we can see that predicted temperature drops as windspeed increases. We can plot this to visualize the effect:</span>
<span id="cb40-406"><a href="#cb40-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-407"><a href="#cb40-407" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mfx-plot-simple}</span></span>
<span id="cb40-408"><a href="#cb40-408" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predicted_values, <span class="fu">aes</span>(<span class="at">x =</span> windSpeed, <span class="at">y =</span> .fitted)) <span class="sc">+</span></span>
<span id="cb40-409"><a href="#cb40-409" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high),</span>
<span id="cb40-410"><a href="#cb40-410" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"#BF3984"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb40-411"><a href="#cb40-411" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"#BF3984"</span>) <span class="sc">+</span></span>
<span id="cb40-412"><a href="#cb40-412" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Wind speed (MPH)"</span>, <span class="at">y =</span> <span class="st">"Predicted high temperature (F)"</span>) <span class="sc">+</span></span>
<span id="cb40-413"><a href="#cb40-413" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb40-414"><a href="#cb40-414" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-415"><a href="#cb40-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-416"><a href="#cb40-416" aria-hidden="true" tabindex="-1"></a>We just manipulated one of the model coefficients and held everything else at its mean. We can manipulate multiple variables too and encode them all on the graph. For instance, what is the effect of windspeed *and* cloud cover on the temperature?</span>
<span id="cb40-417"><a href="#cb40-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-418"><a href="#cb40-418" aria-hidden="true" tabindex="-1"></a>We'll follow the same process, but vary both <span class="in">`windSpeed`</span> and <span class="in">`cloudCover_scaled`</span>. Instead of using <span class="in">`tibble()`</span>, we use <span class="in">`exapnd_grid()`</span>, which creates every combination of the variables we specify. Instead of varying cloud cover by every possible value (like from 0 to 100), we'll choose four possible cloud cover types: 0%, 33%, 66%, and 100%. Everything else will be at its mean.</span>
<span id="cb40-419"><a href="#cb40-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-420"><a href="#cb40-420" aria-hidden="true" tabindex="-1"></a><span class="in">```{r newdata-fancy}</span></span>
<span id="cb40-421"><a href="#cb40-421" aria-hidden="true" tabindex="-1"></a>newdata_fancy <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">windSpeed =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">8</span>, <span class="fl">0.5</span>),</span>
<span id="cb40-422"><a href="#cb40-422" aria-hidden="true" tabindex="-1"></a>                             <span class="at">pressure =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>pressure),</span>
<span id="cb40-423"><a href="#cb40-423" aria-hidden="true" tabindex="-1"></a>                             <span class="at">precipProbability_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>precipProbability_scaled),</span>
<span id="cb40-424"><a href="#cb40-424" aria-hidden="true" tabindex="-1"></a>                             <span class="at">moonPhase_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>moonPhase_scaled),</span>
<span id="cb40-425"><a href="#cb40-425" aria-hidden="true" tabindex="-1"></a>                             <span class="at">humidity_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>humidity_scaled),</span>
<span id="cb40-426"><a href="#cb40-426" aria-hidden="true" tabindex="-1"></a>                             <span class="at">cloudCover_scaled =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">33</span>, <span class="dv">66</span>, <span class="dv">100</span>))</span>
<span id="cb40-427"><a href="#cb40-427" aria-hidden="true" tabindex="-1"></a>newdata_fancy</span>
<span id="cb40-428"><a href="#cb40-428" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-429"><a href="#cb40-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-430"><a href="#cb40-430" aria-hidden="true" tabindex="-1"></a>Notice now that <span class="in">`windSpeed`</span> repeats four times (0, 0, 0, 0, 0.5, 0.5, etc.), since there are four possible <span class="in">`cloudCover_scaled`</span> values (0, 33, 66, 100). </span>
<span id="cb40-431"><a href="#cb40-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-432"><a href="#cb40-432" aria-hidden="true" tabindex="-1"></a>We can plot this now, just like before, with wind speed on the x-axis, the predicted temperature on the y-axis, and colored and faceted by cloud cover:</span>
<span id="cb40-433"><a href="#cb40-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-434"><a href="#cb40-434" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mfx-complex, fig.width=9, fig.height=4}</span></span>
<span id="cb40-435"><a href="#cb40-435" aria-hidden="true" tabindex="-1"></a>predicted_values_fancy <span class="ot">&lt;-</span> <span class="fu">augment</span>(model_complex, </span>
<span id="cb40-436"><a href="#cb40-436" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">newdata =</span> newdata_fancy, </span>
<span id="cb40-437"><a href="#cb40-437" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">se_fit =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb40-438"><a href="#cb40-438" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">conf.low =</span> .fitted <span class="sc">+</span> (<span class="sc">-</span><span class="fl">1.96</span> <span class="sc">*</span> .se.fit),</span>
<span id="cb40-439"><a href="#cb40-439" aria-hidden="true" tabindex="-1"></a>         <span class="at">conf.high =</span> .fitted <span class="sc">+</span> (<span class="fl">1.96</span> <span class="sc">*</span> .se.fit)) <span class="sc">%&gt;%</span> </span>
<span id="cb40-440"><a href="#cb40-440" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make cloud cover a categorical variable so we can facet with it</span></span>
<span id="cb40-441"><a href="#cb40-441" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cloudCover_scaled =</span> <span class="fu">factor</span>(cloudCover_scaled))</span>
<span id="cb40-442"><a href="#cb40-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-443"><a href="#cb40-443" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predicted_values_fancy, <span class="fu">aes</span>(<span class="at">x =</span> windSpeed, <span class="at">y =</span> .fitted)) <span class="sc">+</span></span>
<span id="cb40-444"><a href="#cb40-444" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high, <span class="at">fill =</span> cloudCover_scaled),</span>
<span id="cb40-445"><a href="#cb40-445" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb40-446"><a href="#cb40-446" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> cloudCover_scaled), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb40-447"><a href="#cb40-447" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Wind speed (MPH)"</span>, <span class="at">y =</span> <span class="st">"Predicted high temperature (F)"</span>) <span class="sc">+</span></span>
<span id="cb40-448"><a href="#cb40-448" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb40-449"><a href="#cb40-449" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="st">"none"</span>, <span class="at">color =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb40-450"><a href="#cb40-450" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(cloudCover_scaled), <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb40-451"><a href="#cb40-451" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-452"><a href="#cb40-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-453"><a href="#cb40-453" aria-hidden="true" tabindex="-1"></a>That's so neat! Temperatures go down slightly as cloud cover increases. If we wanted to improve the model, we'd add an interaction term between cloud cover and windspeed so that each line would have a different slope in addition to a different intercept, but that's beyond the scope of this class.</span>
<span id="cb40-454"><a href="#cb40-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-455"><a href="#cb40-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-456"><a href="#cb40-456" aria-hidden="true" tabindex="-1"></a><span class="fu">## Predicted values and marginal effects in 2023</span></span>
<span id="cb40-457"><a href="#cb40-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-458"><a href="#cb40-458" aria-hidden="true" tabindex="-1"></a>Instead of using <span class="in">`expand_grid()`</span> and <span class="in">`augment()`</span> to create and plug in a mini dataset of variables to move up and down, we can use <span class="co">[</span><span class="ot">the {marginaleffects} package</span><span class="co">](https://vincentarelbundock.github.io/marginaleffects/)</span> to simplify life!</span>
<span id="cb40-459"><a href="#cb40-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-460"><a href="#cb40-460" aria-hidden="true" tabindex="-1"></a>Remember above where we wanted to see the effect of wind speed on temperature while holding all other variables in the model constant. We had to create a small data frame (<span class="in">`newdata`</span>) with columns for each of the variables in the model, with everything except <span class="in">`windSpeed`</span> set to their averages. We then plugged <span class="in">`newdata`</span> into the model with <span class="in">`augment()`</span> and calculated the confidence interval around each predicted value using <span class="in">`mutate()`</span>. It's a fairly involved process, but it works: </span>
<span id="cb40-461"><a href="#cb40-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-462"><a href="#cb40-462" aria-hidden="true" tabindex="-1"></a><span class="in">```{r manual-predicted-values}</span></span>
<span id="cb40-463"><a href="#cb40-463" aria-hidden="true" tabindex="-1"></a><span class="co"># Make model</span></span>
<span id="cb40-464"><a href="#cb40-464" aria-hidden="true" tabindex="-1"></a>model_complex <span class="ot">&lt;-</span> <span class="fu">lm</span>(temperatureHigh <span class="sc">~</span> humidity_scaled <span class="sc">+</span> moonPhase_scaled <span class="sc">+</span> </span>
<span id="cb40-465"><a href="#cb40-465" aria-hidden="true" tabindex="-1"></a>                      precipProbability_scaled <span class="sc">+</span> windSpeed <span class="sc">+</span> pressure <span class="sc">+</span> cloudCover_scaled,</span>
<span id="cb40-466"><a href="#cb40-466" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> weather_atl_summer)</span>
<span id="cb40-467"><a href="#cb40-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-468"><a href="#cb40-468" aria-hidden="true" tabindex="-1"></a><span class="co"># Make mini dataset</span></span>
<span id="cb40-469"><a href="#cb40-469" aria-hidden="true" tabindex="-1"></a>newdata <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">windSpeed =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">8</span>, <span class="fl">0.5</span>),</span>
<span id="cb40-470"><a href="#cb40-470" aria-hidden="true" tabindex="-1"></a>                  <span class="at">pressure =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>pressure),</span>
<span id="cb40-471"><a href="#cb40-471" aria-hidden="true" tabindex="-1"></a>                  <span class="at">precipProbability_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>precipProbability_scaled),</span>
<span id="cb40-472"><a href="#cb40-472" aria-hidden="true" tabindex="-1"></a>                  <span class="at">moonPhase_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>moonPhase_scaled),</span>
<span id="cb40-473"><a href="#cb40-473" aria-hidden="true" tabindex="-1"></a>                  <span class="at">humidity_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>humidity_scaled),</span>
<span id="cb40-474"><a href="#cb40-474" aria-hidden="true" tabindex="-1"></a>                  <span class="at">cloudCover_scaled =</span> <span class="fu">mean</span>(weather_atl_summer<span class="sc">$</span>cloudCover_scaled))</span>
<span id="cb40-475"><a href="#cb40-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-476"><a href="#cb40-476" aria-hidden="true" tabindex="-1"></a><span class="co"># Plug mini dataset into model</span></span>
<span id="cb40-477"><a href="#cb40-477" aria-hidden="true" tabindex="-1"></a>predicted_values <span class="ot">&lt;-</span> <span class="fu">augment</span>(model_complex, </span>
<span id="cb40-478"><a href="#cb40-478" aria-hidden="true" tabindex="-1"></a>                            <span class="at">newdata =</span> newdata,</span>
<span id="cb40-479"><a href="#cb40-479" aria-hidden="true" tabindex="-1"></a>                            <span class="at">se_fit =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb40-480"><a href="#cb40-480" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">conf.low =</span> .fitted <span class="sc">+</span> (<span class="sc">-</span><span class="fl">1.96</span> <span class="sc">*</span> .se.fit),</span>
<span id="cb40-481"><a href="#cb40-481" aria-hidden="true" tabindex="-1"></a>         <span class="at">conf.high =</span> .fitted <span class="sc">+</span> (<span class="fl">1.96</span> <span class="sc">*</span> .se.fit))</span>
<span id="cb40-482"><a href="#cb40-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-483"><a href="#cb40-483" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at predicted values</span></span>
<span id="cb40-484"><a href="#cb40-484" aria-hidden="true" tabindex="-1"></a>predicted_values <span class="sc">%&gt;%</span> </span>
<span id="cb40-485"><a href="#cb40-485" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(windSpeed, .fitted, .se.fit, conf.low, conf.high) <span class="sc">%&gt;%</span> </span>
<span id="cb40-486"><a href="#cb40-486" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span>
<span id="cb40-487"><a href="#cb40-487" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-488"><a href="#cb40-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-489"><a href="#cb40-489" aria-hidden="true" tabindex="-1"></a>The {marginaleffects} package makes this far easier. We can use the <span class="in">`predictions()`</span> function to generate, um, predictions. We still need to feed it a smaller dataset of variables to manipulate, but if we use the <span class="in">`datagrid()`</span> function, we *only have to specify the variables we want to move*. It will automatically use the averages or typical values for all other variables in the model. It will also automatically create confidence intervals for each prediction—no need for the <span class="in">`mutate(conf.low = .fitted + (-1.96 * .se.fit))`</span> math that we did previously.</span>
<span id="cb40-490"><a href="#cb40-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-491"><a href="#cb40-491" aria-hidden="true" tabindex="-1"></a><span class="in">```{r calc-preds-easy}</span></span>
<span id="cb40-492"><a href="#cb40-492" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(marginaleffects)</span>
<span id="cb40-493"><a href="#cb40-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-494"><a href="#cb40-494" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate predictions across a range of windSpeed</span></span>
<span id="cb40-495"><a href="#cb40-495" aria-hidden="true" tabindex="-1"></a>predicted_values_easy <span class="ot">&lt;-</span> <span class="fu">predictions</span>(</span>
<span id="cb40-496"><a href="#cb40-496" aria-hidden="true" tabindex="-1"></a>  model_complex,</span>
<span id="cb40-497"><a href="#cb40-497" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">datagrid</span>(<span class="at">windSpeed =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">8</span>, <span class="fl">0.5</span>))</span>
<span id="cb40-498"><a href="#cb40-498" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-499"><a href="#cb40-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-500"><a href="#cb40-500" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at predicted values</span></span>
<span id="cb40-501"><a href="#cb40-501" aria-hidden="true" tabindex="-1"></a>predicted_values_easy <span class="sc">%&gt;%</span></span>
<span id="cb40-502"><a href="#cb40-502" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(windSpeed, estimate, std.error, conf.low, conf.high)</span>
<span id="cb40-503"><a href="#cb40-503" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-504"><a href="#cb40-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-505"><a href="#cb40-505" aria-hidden="true" tabindex="-1"></a>We can then plot this really easily too:</span>
<span id="cb40-506"><a href="#cb40-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-507"><a href="#cb40-507" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mfx-plot-easy-pred}</span></span>
<span id="cb40-508"><a href="#cb40-508" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predicted_values_easy, <span class="fu">aes</span>(<span class="at">x =</span> windSpeed, <span class="at">y =</span> estimate)) <span class="sc">+</span></span>
<span id="cb40-509"><a href="#cb40-509" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high),</span>
<span id="cb40-510"><a href="#cb40-510" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"#BF3984"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb40-511"><a href="#cb40-511" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"#BF3984"</span>) <span class="sc">+</span></span>
<span id="cb40-512"><a href="#cb40-512" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Wind speed (MPH)"</span>, <span class="at">y =</span> <span class="st">"Predicted high temperature (F)"</span>) <span class="sc">+</span></span>
<span id="cb40-513"><a href="#cb40-513" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb40-514"><a href="#cb40-514" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-515"><a href="#cb40-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-516"><a href="#cb40-516" aria-hidden="true" tabindex="-1"></a>This works when moving multiple variables at the same time, too. Earlier we used <span class="in">`expand_grid()`</span> to create a mini dataset of different values for both <span class="in">`windSpeed`</span> and <span class="in">`cloudCover`</span>, while holding all the other variables at their means. Here's how to do that with the much easier <span class="in">`predictions()`</span> function:</span>
<span id="cb40-517"><a href="#cb40-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-518"><a href="#cb40-518" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mfx-plot-complex-pred, fig.width=9, fig.height=4}</span></span>
<span id="cb40-519"><a href="#cb40-519" aria-hidden="true" tabindex="-1"></a>predicted_values_fancy_easy <span class="ot">&lt;-</span> <span class="fu">predictions</span>(</span>
<span id="cb40-520"><a href="#cb40-520" aria-hidden="true" tabindex="-1"></a>  model_complex,</span>
<span id="cb40-521"><a href="#cb40-521" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">datagrid</span>(<span class="at">windSpeed =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">8</span>, <span class="fl">0.5</span>),</span>
<span id="cb40-522"><a href="#cb40-522" aria-hidden="true" tabindex="-1"></a>                     <span class="at">cloudCover_scaled =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">33</span>, <span class="dv">66</span>, <span class="dv">100</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb40-523"><a href="#cb40-523" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make cloud cover a categorical variable so we can facet with it</span></span>
<span id="cb40-524"><a href="#cb40-524" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cloudCover_scaled =</span> <span class="fu">factor</span>(cloudCover_scaled))</span>
<span id="cb40-525"><a href="#cb40-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-526"><a href="#cb40-526" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predicted_values_fancy_easy, <span class="fu">aes</span>(<span class="at">x =</span> windSpeed, <span class="at">y =</span> estimate)) <span class="sc">+</span></span>
<span id="cb40-527"><a href="#cb40-527" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high, <span class="at">fill =</span> cloudCover_scaled),</span>
<span id="cb40-528"><a href="#cb40-528" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb40-529"><a href="#cb40-529" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> cloudCover_scaled), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb40-530"><a href="#cb40-530" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Wind speed (MPH)"</span>, <span class="at">y =</span> <span class="st">"Predicted high temperature (F)"</span>) <span class="sc">+</span></span>
<span id="cb40-531"><a href="#cb40-531" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb40-532"><a href="#cb40-532" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="st">"none"</span>, <span class="at">color =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb40-533"><a href="#cb40-533" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(cloudCover_scaled), <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb40-534"><a href="#cb40-534" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-535"><a href="#cb40-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-536"><a href="#cb40-536" aria-hidden="true" tabindex="-1"></a>That's it! <span class="in">`predictions()`</span> makes this so easy!</span>
<span id="cb40-537"><a href="#cb40-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-538"><a href="#cb40-538" aria-hidden="true" tabindex="-1"></a>If we're interested in the slopes (or marginal effects) of these lines, we can calculate these really easily too with the <span class="in">`slopes()`</span> function. For instance, here are the predicted temperatures when just manipulating wind speed:</span>
<span id="cb40-539"><a href="#cb40-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-540"><a href="#cb40-540" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mfx-plot-easy-pred-again}</span></span>
<span id="cb40-541"><a href="#cb40-541" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predicted_values_easy, <span class="fu">aes</span>(<span class="at">x =</span> windSpeed, <span class="at">y =</span> estimate)) <span class="sc">+</span></span>
<span id="cb40-542"><a href="#cb40-542" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high),</span>
<span id="cb40-543"><a href="#cb40-543" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">"#BF3984"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb40-544"><a href="#cb40-544" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"#BF3984"</span>) <span class="sc">+</span></span>
<span id="cb40-545"><a href="#cb40-545" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Wind speed (MPH)"</span>, <span class="at">y =</span> <span class="st">"Predicted high temperature (F)"</span>) <span class="sc">+</span></span>
<span id="cb40-546"><a href="#cb40-546" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb40-547"><a href="#cb40-547" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-548"><a href="#cb40-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-549"><a href="#cb40-549" aria-hidden="true" tabindex="-1"></a>If we want to see what the slope of that line is when wind speed is 2, 4 and 6, we can use <span class="in">`slopes()`</span>:</span>
<span id="cb40-550"><a href="#cb40-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-551"><a href="#cb40-551" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-mfx}</span></span>
<span id="cb40-552"><a href="#cb40-552" aria-hidden="true" tabindex="-1"></a><span class="fu">slopes</span>(model_complex, </span>
<span id="cb40-553"><a href="#cb40-553" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">datagrid</span>(<span class="at">windSpeed =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>)), </span>
<span id="cb40-554"><a href="#cb40-554" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"windSpeed"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-555"><a href="#cb40-555" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This creates a ton of extra columns so we'll just look at a few</span></span>
<span id="cb40-556"><a href="#cb40-556" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(term, windSpeed, estimate, std.error, p.value, conf.low, conf.high, predicted)</span>
<span id="cb40-557"><a href="#cb40-557" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-558"><a href="#cb40-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-559"><a href="#cb40-559" aria-hidden="true" tabindex="-1"></a>The <span class="in">`estimate`</span> column here shows that slope at each of those values of <span class="in">`windSpeed`</span> is -1.8, meaning a 1-MPH increase in wind speed is associated with a nearly 2° decrease in predicted high temperature, on average. That's not super exciting though, since the predicted values create a nice straight line, with the same slope across the whole range of the line. It's also the same number we get from the model coefficient—run <span class="in">`tidy(model_complex)`</span> and you'll see that the coefficient for <span class="in">`windSpeed`</span> is -1.78. Since everything is linear here, using <span class="in">`slopes()`</span> isn't that important.</span>
<span id="cb40-560"><a href="#cb40-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-561"><a href="#cb40-561" aria-hidden="true" tabindex="-1"></a>For bonus fun and excitement, let's make an even more complex model with some non-linear curvy stuff and some interaction terms. We'll include both wind speed and wind speed squared (since maybe higher wind speeds have a larger effect on predicted temperatures), and the interaction between wind speed and cloud cover (since maybe temperature behaves differently at different combinations of wind speed and cloud cover). Again, I'm not a meteorologist so this model is *definitely wrong*, but it gives us some neat moving parts we can play with.</span>
<span id="cb40-562"><a href="#cb40-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-563"><a href="#cb40-563" aria-hidden="true" tabindex="-1"></a><span class="in">```{r wild-model}</span></span>
<span id="cb40-564"><a href="#cb40-564" aria-hidden="true" tabindex="-1"></a><span class="co"># Make model</span></span>
<span id="cb40-565"><a href="#cb40-565" aria-hidden="true" tabindex="-1"></a><span class="co"># We square windSpeed with I(windSpeed^2). The I() function lets you do math</span></span>
<span id="cb40-566"><a href="#cb40-566" aria-hidden="true" tabindex="-1"></a><span class="co"># with regression terms.</span></span>
<span id="cb40-567"><a href="#cb40-567" aria-hidden="true" tabindex="-1"></a><span class="co"># We make an interaction term with *</span></span>
<span id="cb40-568"><a href="#cb40-568" aria-hidden="true" tabindex="-1"></a>model_wild <span class="ot">&lt;-</span> <span class="fu">lm</span>(temperatureHigh <span class="sc">~</span> humidity_scaled <span class="sc">+</span> moonPhase_scaled <span class="sc">+</span> </span>
<span id="cb40-569"><a href="#cb40-569" aria-hidden="true" tabindex="-1"></a>                   precipProbability_scaled <span class="sc">+</span> windSpeed <span class="sc">+</span> <span class="fu">I</span>(windSpeed<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb40-570"><a href="#cb40-570" aria-hidden="true" tabindex="-1"></a>                   pressure <span class="sc">+</span> cloudCover_scaled <span class="sc">+</span> (windSpeed <span class="sc">*</span> cloudCover_scaled),</span>
<span id="cb40-571"><a href="#cb40-571" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> weather_atl_summer)</span>
<span id="cb40-572"><a href="#cb40-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-573"><a href="#cb40-573" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_wild)</span>
<span id="cb40-574"><a href="#cb40-574" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-575"><a href="#cb40-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-576"><a href="#cb40-576" aria-hidden="true" tabindex="-1"></a>We have some strange new regression coefficients now. We have two coefficients for wind speed: <span class="in">`windSpeed`</span> and <span class="in">`I(windSpeed^2)`</span>. We also have a coefficient for the interaction term <span class="in">`windspeed:cloudCover_scaled`</span>. **We cannot interpret these individually**. If we want to know the effect of wind speed on high temperatures, we have to incorporate all three of these new coefficients simultaneously. Fortunately <span class="in">`predictions()`</span> and <span class="in">`slopes()`</span> both handle that for us automatically.</span>
<span id="cb40-577"><a href="#cb40-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-578"><a href="#cb40-578" aria-hidden="true" tabindex="-1"></a>Let's plot the predictions to see that everything is more curvy now (and differently curved across different levels of cloud cover).</span>
<span id="cb40-579"><a href="#cb40-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-580"><a href="#cb40-580" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mfx-predictions-wild, fig.width=9, fig.height=4}</span></span>
<span id="cb40-581"><a href="#cb40-581" aria-hidden="true" tabindex="-1"></a>predicted_values_wild <span class="ot">&lt;-</span> <span class="fu">predictions</span>(</span>
<span id="cb40-582"><a href="#cb40-582" aria-hidden="true" tabindex="-1"></a>  model_wild, </span>
<span id="cb40-583"><a href="#cb40-583" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">datagrid</span>(<span class="at">windSpeed =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">8</span>, <span class="fl">0.5</span>),</span>
<span id="cb40-584"><a href="#cb40-584" aria-hidden="true" tabindex="-1"></a>                     <span class="at">cloudCover_scaled =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">33</span>, <span class="dv">66</span>, <span class="dv">100</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb40-585"><a href="#cb40-585" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make cloud cover a categorical variable so we can facet with it</span></span>
<span id="cb40-586"><a href="#cb40-586" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cloudCover_scaled =</span> <span class="fu">factor</span>(cloudCover_scaled))</span>
<span id="cb40-587"><a href="#cb40-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-588"><a href="#cb40-588" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predicted_values_wild, <span class="fu">aes</span>(<span class="at">x =</span> windSpeed, <span class="at">y =</span> estimate)) <span class="sc">+</span></span>
<span id="cb40-589"><a href="#cb40-589" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high, <span class="at">fill =</span> cloudCover_scaled),</span>
<span id="cb40-590"><a href="#cb40-590" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb40-591"><a href="#cb40-591" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> cloudCover_scaled), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb40-592"><a href="#cb40-592" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Wind speed (MPH)"</span>, <span class="at">y =</span> <span class="st">"Predicted high temperature (F)"</span>) <span class="sc">+</span></span>
<span id="cb40-593"><a href="#cb40-593" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb40-594"><a href="#cb40-594" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="st">"none"</span>, <span class="at">color =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb40-595"><a href="#cb40-595" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(cloudCover_scaled), <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb40-596"><a href="#cb40-596" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-597"><a href="#cb40-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-598"><a href="#cb40-598" aria-hidden="true" tabindex="-1"></a>That's neat! At all the different levels of cloud cover, the wind speed trend is fairly shallow (and even pretty flat when cloud cover is 0 or 33) at low levels of wind speed. The line drops fairly quickly as wind speed increases though. Let's get some exact numbers with <span class="in">`marginaleffects()`</span>:</span>
<span id="cb40-599"><a href="#cb40-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-600"><a href="#cb40-600" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show-mfx-wild}</span></span>
<span id="cb40-601"><a href="#cb40-601" aria-hidden="true" tabindex="-1"></a><span class="fu">slopes</span>(model_wild, </span>
<span id="cb40-602"><a href="#cb40-602" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">datagrid</span>(<span class="at">windSpeed =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>),</span>
<span id="cb40-603"><a href="#cb40-603" aria-hidden="true" tabindex="-1"></a>    <span class="at">cloudCover_scaled =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">33</span>, <span class="dv">66</span>, <span class="dv">100</span>)), </span>
<span id="cb40-604"><a href="#cb40-604" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"windSpeed"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-605"><a href="#cb40-605" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This creates a ton of extra columns so we'll just look at a few</span></span>
<span id="cb40-606"><a href="#cb40-606" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(term, windSpeed, estimate, std.error, p.value, conf.low, conf.high, predicted)</span>
<span id="cb40-607"><a href="#cb40-607" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-608"><a href="#cb40-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-609"><a href="#cb40-609" aria-hidden="true" tabindex="-1"></a>Phew, we have 12 different slopes here. Let's talk through a few of them to get the intuition. If cloud cover is 0 and wind speed is 2 MPH, moving from 2 to 3 MPH is associated with a -0.68° decrease in high temperature on average (see the <span class="in">`estimate`</span> column in the first row in the table). If the existing wind speed is 6 MPH, moving from 6 to 7 is associated with a -2.27° decrease in high temperature on average (see the <span class="in">`estimate`</span> column in the 9th row of the table). The slope is steeper and more negative when the wind is faster, so changes in temperature are more dramatic. Because we have an interaction with cloud cover, the slope also changes at different levels of cloud cover. At 2 MPH of wind, the slope is -0.68° when cloud cover is 0 (first row), but -1.37° when cloud cover is 100 (4th row). </span>
<span id="cb40-610"><a href="#cb40-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-611"><a href="#cb40-611" aria-hidden="true" tabindex="-1"></a>Finally, we can visualize how these slopes change across wind speed and cloud cover by plotting them:</span>
<span id="cb40-612"><a href="#cb40-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-613"><a href="#cb40-613" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-mfx-slopes-wild, fig.width=9, fig.height=4.5}</span></span>
<span id="cb40-614"><a href="#cb40-614" aria-hidden="true" tabindex="-1"></a>slopes_wild <span class="ot">&lt;-</span> <span class="fu">slopes</span>(</span>
<span id="cb40-615"><a href="#cb40-615" aria-hidden="true" tabindex="-1"></a>  model_wild, </span>
<span id="cb40-616"><a href="#cb40-616" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">datagrid</span>(<span class="at">windSpeed =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">6</span>, <span class="at">by =</span> <span class="fl">0.1</span>),</span>
<span id="cb40-617"><a href="#cb40-617" aria-hidden="true" tabindex="-1"></a>                     <span class="at">cloudCover_scaled =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">33</span>, <span class="dv">66</span>, <span class="dv">100</span>)), </span>
<span id="cb40-618"><a href="#cb40-618" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"windSpeed"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-619"><a href="#cb40-619" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cloudCover_scaled =</span> <span class="fu">factor</span>(cloudCover_scaled))</span>
<span id="cb40-620"><a href="#cb40-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-621"><a href="#cb40-621" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(slopes_wild, <span class="fu">aes</span>(<span class="at">x =</span> windSpeed, <span class="at">y =</span> estimate)) <span class="sc">+</span></span>
<span id="cb40-622"><a href="#cb40-622" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> conf.low, <span class="at">ymax =</span> conf.high, <span class="at">fill =</span> cloudCover_scaled),</span>
<span id="cb40-623"><a href="#cb40-623" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb40-624"><a href="#cb40-624" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> cloudCover_scaled), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb40-625"><a href="#cb40-625" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Wind speed (MPH)"</span>, <span class="at">y =</span> <span class="st">"Slope (marginal effect) of wind speed"</span>,</span>
<span id="cb40-626"><a href="#cb40-626" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Marginal effect of wind speed across levels of cloud cover"</span>,</span>
<span id="cb40-627"><a href="#cb40-627" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"These are *slopes*, not predicted values"</span>) <span class="sc">+</span></span>
<span id="cb40-628"><a href="#cb40-628" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb40-629"><a href="#cb40-629" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="st">"none"</span>, <span class="at">color =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb40-630"><a href="#cb40-630" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(cloudCover_scaled), <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb40-631"><a href="#cb40-631" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Content <i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> 2024 by <a href="https://www.andrewheiss.com/">Andrew Heiss</a> <br> All content licensed under a <i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> <i class="fa-brands fa-creative-commons-by" aria-label="creative-commons-by"></i> <i class="fa-brands fa-creative-commons-nc" aria-label="creative-commons-nc"></i> <a href="https://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International license (CC BY-NC 4.0)</a></div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">Made with <i class="fa-brands fa-r-project" aria-label="r-project"></i> and <a href="https://quarto.org/">Quarto</a><br> <a href="https://github.com/aysps/Data-Visualization_2024/">View the source at <i class="fa-brands fa-github" aria-label="github"></i> GitHub</a></div>
  </div>
</footer>



</body></html>